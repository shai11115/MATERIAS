<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Acad√©mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Import html2canvas and jsPDF libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Import Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* MINIMALIST REDESIGN */
        :root {
            --bg-color: #f7fafc;
            --text-color: #2d3748;
            --header-bg: white;
            --card-bg: white;
            --secondary-bg: #edf2f7;
            --border-color: #e2e8f0;
            --placeholder-color: #a0aec0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --modal-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: white;
            --modal-inner-bg: #f7fafc;
        }

        body.dark-mode {
            --bg-color: #1a202c;
            --text-color: #f7fafc;
            --header-bg: #2d3748;
            --card-bg: #2d3748;
            --secondary-bg: #4a5568;
            --border-color: #4a5568;
            --placeholder-color: #718096;
            --shadow: 0 4px 6px -1-px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            --modal-bg: rgba(255, 255, 255, 0.2);
            --modal-content-bg: #1a202c;
            --modal-inner-bg: #2d3748;
            /* NEW: Dark mode table border color */
            --table-border-color: #4c525f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem;
        }
        /* Header */
        .header {
            background-color: var(--header-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            position: relative;
            text-align: center;
        }
        /* MODIFIED: Ensure header text changes with dark mode */
        .header h1,
        .header h3,
        .header p,
        .calendar-main-button {
            color: var(--text-color);
        }
        .dark-mode .header h1,
        .dark-mode .header h3,
        .dark-mode .header p,
        .dark-mode .calendar-main-button {
            color: var(--text-color);
        }

        .settings-icon, .palette-icon, .goals-icon, .dark-mode-icon {
            position: absolute;
            top: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--placeholder-color);
            transition: color 0.2s ease;
            z-index: 10;
        }
        .settings-icon:hover, .palette-icon:hover, .goals-icon:hover, .dark-mode-icon:hover {
            color: var(--text-color);
        }
        .settings-icon { left: 1rem; }
        .palette-icon { left: 4rem; }
        .goals-icon { left: 7rem; }
        .dark-mode-icon { right: 1rem; }
        #careerTitleDisplay {
            word-break: break-word;
            hyphens: auto;
            margin: 0 auto;
            margin-top: 1.5rem;
            max-width: calc(100% - 6rem);
            line-height: 1.2;
        }
        /* Progress Bars */
        .progress-bar-container {
            background-color: var(--border-color);
            border-radius: 9999px;
            height: 1.25rem;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        /* MODIFIED: Change progress bar text color to match title in light mode and white in dark mode */
        .progress-bar {
            height: 100%;
            background-color: #4299e1;
            border-radius: 9999px;
            text-align: center;
            color: var(--text-color);
            font-weight: 600;
            line-height: 1.25rem;
            transition: width 0.5s ease-in-out;
        }
        .dark-mode .progress-bar {
            color: white;
        }
        /* Buttons */
        .year-selection-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .year-button, .calendar-main-button, #addYearBtn, #removeYearBtn, .add-subject-btn, .delete-subjects-btn, .download-schedule-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .year-button, #addYearBtn, #removeYearBtn {
            color: var(--text-color);
        }
        .dark-mode .year-button, .dark-mode #addYearBtn, .dark-mode #removeYearBtn {
            color: white;
        }
        .year-button:hover, .calendar-main-button:hover, #addYearBtn:hover, #removeYearBtn:hover, .add-subject-btn:hover, .delete-subjects-btn:hover, .download-schedule-btn:hover {
            filter: brightness(90%);
        }
        /* MODIFIED: Active year button text should be black in dark mode, white in light mode. */
        .year-button.active, .calendar-main-button.active {
            background-color: #3182ce;
            color: white;
            border-color: #2c5282;
        }
        .dark-mode .year-button.active {
            color: black;
        }
        .calendar-main-button {
            color: var(--text-color);
        }
        .dark-mode .calendar-main-button {
            color: white;
        }
        /* Compact icon buttons for semester actions */
        .semester-action-btn {
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
        }
        /* Semester Section */
        .semester-section {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            transition: background-color 0.3s;
        }
        /* MODIFIED: Ensure semester and section titles are dynamically colored */
        .semester-section h2,
        .semester-section h3 {
            color: var(--text-color);
        }
        /* NEW: Rule to make the empty state message white in dark mode */
        .dark-mode .semester-section p.text-gray-500 {
            color: white;
        }
        .subject-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            position: relative;
            border: 1px solid var(--border-color);
            border-left-width: 8px;
            background-color: var(--card-bg);
        }
        .subject-item:hover {
            background-color: var(--secondary-bg);
        }
        .subject-item.type-Obligatoria { border-left-color: #f6ad55; }
        .subject-item.type-Opcional { border-left-color: #48bb78; }
        .subject-item.type-Electiva { border-left-color: #ed64a6; }

        .subject-item-main-content {
            display: flex;
            align-items: flex-start;
            width: 100%;
            padding-right: 4rem;
        }
        .subject-checkbox {
            margin-right: 1rem;
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #4299e1;
            cursor: pointer;
            flex-shrink: 0;
        }
        .subject-name {
            font-size: 1.1em;
            color: var(--text-color);
            cursor: pointer;
            word-break: break-word;
            hyphens: auto;
        }
        .subject-name.completed {
            text-decoration: line-through;
            color: var(--placeholder-color);
        }
        .subject-credits-and-code {
            color: var(--placeholder-color);
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .subject-type, .delivery-type {
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
        }
        /* NUEVO: Estilo para los recuadros de informaci√≥n de la materia */
        .subject-info-tag {
            font-size: 0.8em;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        /* Asegurar que el color del texto sea visible en modo oscuro */
        .dark-mode .subject-info-tag {
            color: var(--text-color);
        }

        .summary-button {
            background-color: var(--secondary-bg);
            color: var(--text-color);
        }
        .summary-button:hover {
            background-color: var(--border-color);
        }
        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.25rem;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            background-color: var(--card-bg);
        }
        /* MODIFICADO: A√±adir bordes inferiores a las celdas para las l√≠neas horizontales */
        .schedule-table th, .schedule-table td {
            border: 1px solid var(--border-color);
            border-bottom: 2px solid var(--border-color);
            padding: 0.5rem;
            text-align: center;
            vertical-align: middle;
        }
        .dark-mode .schedule-table th, .dark-mode .schedule-table td {
            border-color: var(--table-border-color); /* NEW: Use new variable for dark mode table borders */
        }
        .schedule-time {
            background-color: var(--secondary-bg);
            font-weight: 500;
        }
        .schedule-entry {
            border-radius: 0.375rem;
            padding: 0.25rem;
            margin: 0.125rem 0;
            font-size: 0.85em;
            color: var(--text-color);
            box-shadow: none;
            border-left: 3px solid;
            background-color: var(--secondary-bg);
        }
        .schedule-entry.type-Obligatoria { border-left-color: #f6ad55; }
        .schedule-entry.type-Opcional { border-left-color: #48bb78; }
        .schedule-entry.type-Electiva { border-left-color: #ed64a6; }
        /* MODIFICADO: El color de la letra para materias con superposici√≥n es rojo */
        .schedule-entry.overlap {
            color: #c53030;
            font-weight: bold;
        }
        .dark-mode .schedule-entry.overlap {
            color: #ff6b6b; /* Rojo para modo oscuro */
        }
        .hidden { display: none; }

        /* Other styles from original */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            background-color: var(--modal-content-bg);
            color: var(--text-color);
        }
        /* MODIFIED: Ensure all text inside modal content, including titles and labels, respects the theme */
        .modal-content h2,
        .modal-content h3,
        .modal-content p,
        .modal-content label {
            color: var(--text-color);
        }
        .modal-content select,
        .modal-content input,
        .modal-content textarea {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        /* MODIFIED: Add a specific rule for the subject list and summary box in dark mode */
        .dark-mode #deleteSubjectList > div,
        .dark-mode #subjectInfoContent > div.bg-gray-100 {
            background-color: var(--secondary-bg) !important;
            color: var(--text-color);
        }
        /* CORREGIDO: Nuevo estilo para el recuadro de notificaciones que respeta el modo oscuro */
        .notification-event-item {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: var(--text-color);
        }
        .dark-mode .notification-event-item {
            background-color: var(--secondary-bg);
        }


        .dark-mode #deleteSubjectList > div > span {
            color: white;
        }
        /* NEW: Dark mode styling for inner modal boxes in gradeStatusModal */
        .modal-inner-box {
            background-color: var(--modal-inner-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .dark-mode .modal-inner-box {
            background-color: var(--secondary-bg);
            border-color: var(--border-color);
        }
        /* NEW: Dark mode styling for text inputs inside dark modals */
        .dark-mode .modal-content input[type="text"],
        .dark-mode .modal-content input[type="number"],
        .dark-mode .modal-content input[type="date"],
        .dark-mode .modal-content input[type="time"],
        .dark-mode .modal-content input[type="url"],
        .dark-mode .modal-content select,
        .dark-mode .modal-content textarea {
            background-color: #4a5568;
            border-color: #6a778e;
            color: white;
        }
        /* NEW: Dark mode for color palette inputs */
        .dark-mode #colorPalettePanel .color-input-container input[type="text"] {
             background-color: #4a5568;
             color: white;
             border-color: #6a778e;
        }
        .dark-mode #colorPalettePanel {
            background-color: #2d3748;
            border-color: #4a5568;
        }


        .semester-credits-total, .total-weekly-hours { margin-top: 1.25rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); font-weight: 600; text-align: right; color: var(--text-color); font-size: 1.1em; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; background-color: var(--secondary-bg); padding: 0.75rem; border-radius: 0.5rem 0.5rem 0 0; font-weight: 600; }
        .calendar-nav-btn { background-color: var(--placeholder-color); color: white; padding: 0.3rem 0.6rem; border-radius: 0.3rem; cursor: pointer; transition: background-color 0.2s ease; }
        .calendar-nav-btn:hover { background-color: #718096; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; padding: 0.75rem; background-color: var(--card-bg); border-radius: 0 0 0.5rem 0.5rem; }
        .calendar-day-header { font-weight: bold; padding: 0.5rem 0; background-color: var(--secondary-bg); border-radius: 0.3rem; }
        .calendar-day { padding: 0.5rem 0; background-color: var(--card-bg); border-radius: 0.3rem; min-height: 50px; position: relative; cursor: pointer; transition: background-color 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .calendar-day:hover { background-color: var(--secondary-bg); }
        .calendar-day.empty { background-color: var(--secondary-bg); cursor: default; }
        .calendar-day.has-exam { background-color: #f6ad55; font-weight: bold; color: white; border: 1px solid #dd6b20; }
        .exam-indicator { font-size: 0.6em; color: #c53030; margin-top: 0.2rem; line-height: 1; }
        .subject-item.previa-unmet { opacity: 0.6; filter: grayscale(50%); border-left-color: var(--placeholder-color); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 1.5rem; flex-direction: column; gap: 1rem; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-banner { background-color: var(--secondary-bg); color: var(--text-color); padding: 0.75rem 1.25rem; border-radius: 0.5rem; margin-top: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .notification-banner:hover { background-color: var(--border-color); }
        .notification-count { background-color: #e53e3e; color: white; border-radius: 50%; padding: 0.2rem 0.6rem; font-size: 0.8em; font-weight: bold; }
        .notification-message { flex-grow: 1; text-align: center; }
        .sub-semester-label {
            font-size: 0.8em;
            color: var(--placeholder-color);
            margin-top: 0;
            margin-bottom: 0;
            text-align: left;
        }
        .dark-mode .sub-semester-label {
            color: var(--text-color);
        }
        #colorPalettePanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
            background-color: var(--modal-content-bg);
            backdrop-filter: blur(5px);
            padding: 1.5rem;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border-color);
            transform: translateY(-100%);
            transition: transform 0.4s ease-in-out;
        }
        #colorPalettePanel.visible { transform: translateY(0); }
        .color-input-group { margin-bottom: 1rem; }
        .color-input-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-color); }
        .color-input-container { display: flex; align-items: center; gap: 0.5rem; }
        .color-input-container input[type="color"] { -webkit-appearance: none; width: 40px; height: 40px; border: none; padding: 0; border-radius: 0.375rem; cursor: pointer; }
        .color-input-container input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-input-container input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border-color); border-radius: 0.375rem; }
        .color-input-container input[type="text"] { font-family: monospace; width: 100px; }
        #academicPathWrapper { position: relative; overflow-x: auto; padding: 2rem; background-color: var(--card-bg); border-radius: 1rem; }
        .path-container { display: flex; gap: 3rem; min-width: max-content; }
        .path-semester-col { display: flex; flex-direction: column; gap: 1.5rem; align-items: center; }
        .path-semester-title { font-weight: bold; color: var(--text-color); margin-bottom: 1rem; white-space: nowrap; }
        .path-node {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            text-align: center;
            width: 150px;
            font-size: 0.9em;
            cursor: default;
            position: relative;
            transition: background-color 0.3s, border-color 0.3s;
            /* MODIFICADO: Permite que el texto de la materia se envuelva */
            word-wrap: break-word;
            white-space: normal;
        }
        .path-connector { position: absolute; background-color: var(--placeholder-color); height: 2px; transform-origin: 0 0; z-index: -1; }
        .tab-button { padding: 0.5rem 1rem; cursor: pointer; border: none; background-color: var(--secondary-bg); border-radius: 0.375rem 0.375rem 0 0; color: var(--text-color); }
        .tab-button.active { background-color: var(--card-bg); border: 1px solid var(--border-color); border-bottom: 1px solid var(--card-bg); }
        .tab-content { display: none; padding: 1rem; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 0.375rem 0.375rem; background-color: var(--card-bg); color: var(--text-color); }
        .tab-content.active { display: block; }
        .goal-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background-color: var(--secondary-bg); border-radius: 0.375rem; }
        .goal-item input[type="checkbox"] { width: 1.25rem; height: 1.25rem; }
        .goal-item span.completed { text-decoration: line-through; color: var(--placeholder-color); }
        .modal {
            background-color: var(--modal-bg);
            transition: background-color 0.3s;
        }

        /* --- NUEVO CSS PARA LA CARGA HORARIA DIARIA --- */
        .daily-load-box {
            background-color: var(--secondary-bg);
            color: var(--text-color); /* El color del texto se heredar√° de aqu√≠ */
        }
        .daily-load-day {
            color: var(--text-color);
        }
        .daily-load-hours {
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .year-selection-buttons { flex-direction: column; align-items: center; }
            .year-button, .calendar-main-button { width: 80%; }
            .subject-item-main-content { flex-wrap: wrap; padding-right: 0.75rem; padding-left: 0.75rem; }
            .subject-checkbox { margin-bottom: 0.5rem; }
            .subject-details { flex-basis: 100%; max-width: none; min-width: unset; margin-bottom: 0.5rem; }
            .subject-tags { flex-basis: 100%; width: auto; min-width: unset; margin-bottom: 0.5rem; }
            .subject-icons { position: absolute; top: 0.5rem; right: 0.5rem; }
            .schedule-table th, .schedule-table td { padding: 0.375rem; font-size: 0.8em; }
            .schedule-entry { font-size: 0.75em; }
            .calendar-day { padding: 0.25rem 0; min-height: 40px; font-size: 0.8em; }
            .exam-indicator { font-size: 0.55em; }
        }

        #custom-colors-style { /* Populated by JS */ }
    </style>
</head>
<body>
    <!-- NEW: Color Palette Panel -->
    <div id="colorPalettePanel" class="shadow-lg">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-4">
                <!-- MODIFIED: Use CSS variable for title color -->
                <h2 class="text-2xl font-bold">Paleta de Colores</h2>
                <div>
                    <button id="resetColorsBtn" class="text-sm text-blue-500 hover:text-blue-700 font-semibold mr-4">Restablecer</button>
                    <button id="closePaletteBtn" class="text-2xl font-bold text-gray-600 hover:text-gray-900">&times;</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- General Colors -->
                <div class="color-input-group">
                    <label for="colorHeaderBg">Fondo del Encabezado</label>
                    <div class="color-input-container">
                        <input type="color" id="colorHeaderBg" data-key="headerBg">
                        <input type="text" id="hexHeaderBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="headerBg">
                    </div>
                </div>
                <!-- Year Button Colors -->
                <div class="color-input-group">
                    <label for="colorYearCompleted">Bot√≥n A√±o (Completado)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorYearCompleted" data-key="yearCompleted">
                        <input type="text" id="hexYearCompleted" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="yearCompleted">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorYearIncomplete">Bot√≥n A√±o (Incompleto)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorYearIncomplete" data-key="yearIncomplete">
                        <input type="text" id="hexYearIncomplete" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="yearIncomplete">
                    </div>
                </div>
                <!-- Subject Type Colors -->
                <div class="color-input-group">
                    <label for="colorTypeObligatoria">Materia (Obligatoria)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorTypeObligatoria" data-key="typeObligatoria">
                        <input type="text" id="hexTypeObligatoria" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="typeObligatoria">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorTypeOpcional">Materia (Opcional)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorTypeOpcional" data-key="typeOpcional">
                        <input type="text" id="hexTypeOpcional" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="typeOpcional">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorTypeElectiva">Materia (Electiva)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorTypeElectiva" data-key="typeElectiva">
                        <input type="text" id="hexTypeElectiva" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="typeElectiva">
                    </div>
                </div>
                <!-- NEW: Completed Subject Color -->
                <div class="color-input-group">
                    <label for="colorCompletedSubjectBg">Materia Completada</label>
                    <div class="color-input-container">
                        <input type="color" id="colorCompletedSubjectBg" data-key="completedSubjectBg">
                        <input type="text" id="hexCompletedSubjectBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="completedSubjectBg">
                    </div>
                </div>
                <!-- Button Colors -->
                <div class="col-span-1 md:col-span-2 lg:col-span-3 mt-4 border-t pt-4">
                    <h3 class="text-xl font-bold">Colores de Botones</h3>
                </div>
                <div class="color-input-group">
                    <label for="colorNavButtonBg">Botones de Navegaci√≥n</label>
                    <div class="color-input-container">
                        <input type="color" id="colorNavButtonBg" data-key="navButtonBg">
                        <input type="text" id="hexNavButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="navButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorAddButtonBg">Bot√≥n Agregar (A√±o)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorAddButtonBg" data-key="addButtonBg">
                        <input type="text" id="hexAddButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="addButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorDeleteButtonBg">Bot√≥n Eliminar (A√±o)</label>
                    <div class="color-input-container">
                        <input type="color" id="colorDeleteButtonBg" data-key="deleteButtonBg">
                        <input type="text" id="hexDeleteButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="deleteButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorAddSubjectButtonBg">Bot√≥n + Materia</label>
                    <div class="color-input-container">
                        <input type="color" id="colorAddSubjectButtonBg" data-key="addSubjectButtonBg">
                        <input type="text" id="hexAddSubjectButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="addSubjectButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorDeleteSubjectsButtonBg">Bot√≥n Eliminar Materias</label>
                    <div class="color-input-container">
                        <input type="color" id="colorDeleteSubjectsButtonBg" data-key="deleteSubjectsButtonBg">
                        <input type="text" id="hexDeleteSubjectsButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="deleteSubjectsButtonBg">
                    </div>
                </div>
                 <!-- NEWLY ADDED COLOR PICKERS -->
                <div class="color-input-group">
                    <label for="colorSaveButtonBg">Bot√≥n Guardar Materia</label>
                    <div class="color-input-container">
                        <input type="color" id="colorSaveButtonBg" data-key="saveButtonBg">
                        <input type="text" id="hexSaveButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="saveButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorDownloadButtonBg">Bot√≥n Descargar Horario</label>
                    <div class="color-input-container">
                        <input type="color" id="colorDownloadButtonBg" data-key="downloadButtonBg">
                        <input type="text" id="hexDownloadButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="downloadButtonBg">
                    </div>
                </div>
                <div class="color-input-group">
                    <label for="colorAddScheduleButtonBg">Bot√≥n Agregar Horario</label>
                    <div class="color-input-container">
                        <input type="color" id="colorAddScheduleButtonBg" data-key="addScheduleButtonBg">
                        <input type="text" id="hexAddScheduleButtonBg" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" data-key="addScheduleButtonBg">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="settings-icon" id="openSettingsModalBtn" aria-label="Abrir Configuraci√≥n" title="Configuraci√≥n">‚öôÔ∏è</div>
            <div class="palette-icon" id="openPaletteBtn" aria-label="Abrir Paleta de Colores" title="Paleta de Colores">üé®</div>
            <div class="goals-icon" id="openGoalsModalBtn" aria-label="Abrir Metas de Estudio" title="Metas de Estudio">üéØ</div>
            <div class="dark-mode-icon" id="darkModeToggle" aria-label="Alternar Modo Oscuro/Claro" title="Modo Oscuro/Claro">‚òÄÔ∏è</div>

            <h1 id="careerTitleDisplay" class="text-4xl font-bold text-gray-800 mb-2">INSERTAR TITULO</h1>
            <p class="text-lg text-gray-600">Tu progreso acad√©mico</p>

            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-2">Cr√©ditos Totales de la Carrera (Disponibles)</h3>
                <p id="totalAvailableCredits" class="text-2xl font-bold text-gray-700 mb-4">0</p>
            </div>

            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-2">Cr√©ditos Totales (Completados)</h3>
                <div class="progress-bar-container">
                    <div id="totalCreditsProgressBar" class="progress-bar" style="width: 0%;">0/0</div>
                </div>
                <p class="text-sm text-gray-500 mt-1">Cr√©ditos obtenidos de <span id="totalCareerCreditsDisplay">0</span> totales para la carrera.</p>
            </div>

            <div class="mt-4">
                <h3 class="text-xl font-semibold mb-2">T√≠tulo Intermedio (<span id="intermediateTitleCreditsDisplay">0</span> Cr√©ditos)</h3>
                <div class="progress-bar-container">
                    <div id="intermediateTitleProgressBar" class="progress-bar" style="width: 0%;">0/0</div>
                </div>
                <p class="text-sm text-gray-500 mt-1">Cr√©ditos para el t√≠tulo intermedio.</p>
            </div>

            <div class="flex justify-center gap-4 mt-6">
                <button id="calendarMainButton" class="calendar-main-button" aria-label="Ver Calendario Lectivo">
                    Calendario Lectivo
                </button>
                <button id="academicPathButton" class="calendar-main-button" aria-label="Ver Camino Acad√©mico">
                    Camino Acad√©mico
                </button>
            </div>

            <div id="notificationBanner" class="notification-banner mx-auto mt-4" role="status" aria-live="polite">
                <span id="notificationMessage" class="notification-message">No hay notificaciones pr√≥ximas.</span>
                <span id="notificationCount" class="notification-count">0</span>
            </div>
        </div>

        <div id="calendarWrapper" class="semester-section mb-8 hidden mx-auto">
            <h2 class="text-2xl font-bold mb-4">Calendario Lectivo</h2>
            <div class="flex justify-center gap-4 mb-4">
                <label for="calendarYearSelect" class="sr-only">Seleccionar A√±o del Calendario</label>
                <select id="calendarYearSelect" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Seleccionar A√±o del Calendario"></select>
            </div>
            <div class="calendar-header">
                <button id="prevMonthBtn" class="calendar-nav-btn" aria-label="Mes Anterior">‚Üê</button>
                <span id="currentMonthYear" aria-live="polite"></span>
                <button id="nextMonthBtn" class="calendar-nav-btn" aria-label="Mes Siguiente">‚Üí</button>
            </div>
            <div id="calendarGrid" class="calendar-grid" role="grid" aria-labelledby="currentMonthYear">
            </div>
        </div>

        <div id="academicPathWrapper" class="hidden mb-8 relative">
            <div id="pathContainer" class="path-container">
            </div>
            <div id="pathConnectors">
            </div>
        </div>

        <div class="flex justify-center gap-4 mb-8">
            <button id="addYearBtn" class="font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Agregar Nuevo A√±o Acad√©mico">
                Agregar A√±o
            </button>
            <button id="removeYearBtn" class="font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Eliminar A√±o Acad√©mico Actual">
                Eliminar A√±o Actual
            </button>
        </div>

        <div class="year-selection-buttons" id="yearSelectionButtons" role="tablist" aria-label="A√±os Acad√©micos">
        </div>

        <div id="semesterContentArea" class="overflow-x-auto">
        </div>
    </div>

    <div id="editSubjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Editar Materia</h2>
            <form id="editSubjectForm">
                <input type="hidden" id="editSubjectId">
                <input type="hidden" id="editSubjectYear">
                <input type="hidden" id="editSubjectSemester">

                <div class="mb-4">
                    <label for="editSubjectName" class="block text-sm font-bold mb-2">Nombre de la Materia:</label>
                    <input type="text" id="editSubjectName" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>

                <div class="flex flex-wrap -mx-2 mb-4">
                    <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
                        <label for="editSubjectCredits" class="block text-sm font-bold mb-2">Cr√©ditos:</label>
                        <input type="number" id="editSubjectCredits" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" min="1" required>
                    </div>

                    <div class="w-full md:w-1/2 px-2">
                        <label for="editSubjectType" class="block text-sm font-bold mb-2">Tipo:</label>
                        <select id="editSubjectType" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="Obligatoria">Obligatoria</option>
                            <option value="Opcional">Opcional</option>
                            <option value="Electiva">Electiva</option>
                        </select>
                    </div>
                </div>

                <div class="flex flex-wrap -mx-2 mb-4">
                    <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
                        <label for="editDeliveryType" class="block text-sm font-bold mb-2">Modalidad:</label>
                        <select id="editDeliveryType" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="Presencial">Presencial</option>
                            <option value="A Distancia">A Distancia</option>
                            <option value="Hibrida">H√≠brida</option>
                        </select>
                    </div>
                    <div class="w-full md:w-1/2 px-2">
                        <label for="editScheduleCode" class="block text-sm font-bold mb-2">C√≥digo Horario (1-10):</label>
                        <input type="number" id="editScheduleCode" min="1" max="10" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="editAssignedCode" class="block text-sm font-bold mb-2">C√≥digo Asignado (4 n√∫meros):</label>
                    <input type="text" id="editAssignedCode" inputmode="numeric" pattern="\d{4}" maxlength="4" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Materias Previas:</label>
                    <div class="flex gap-2 mb-2">
                        <label for="filterPreviaYear" class="sr-only">Filtrar Previas por A√±o</label>
                        <select id="filterPreviaYear" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline w-1/2">
                            <option value="">Todos los A√±os</option>
                        </select>
                        <label for="filterPreviaSemester" class="sr-only">Filtrar Previas por Semestre</label>
                        <select id="filterPreviaSemester" class="shadow border rounded py-2 px-3 leading-tight focus:outline-none focus:shadow-outline w-1/2">
                            <option value="">Todos los Semestres</option>
                        </select>
                    </div>
                    <label for="editSubjectPrevias" class="sr-only">Seleccionar Materias Previas</label>
                    <select id="editSubjectPrevias" multiple class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline h-32" aria-describedby="previa-help-text">
                        <option value="">Sin seleccionar</option>
                    </select>
                    <p id="previa-help-text" class="text-xs mt-1">Ctrl/Cmd + Click para seleccionar m√∫ltiples.</p>
                </div>

                <h3 class="text-xl font-semibold mb-3">Horario de la Materia:</h3>
                <div id="editSubjectScheduleContainer" class="mb-4 space-y-2">
                </div>
                <button type="button" id="addScheduleSlotBtn" class="text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Agregar Horario">
                    Agregar Horario
                </button>
            </form>
            <div class="flex justify-end mt-6">
                <button id="saveSubjectBtn" class="text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Cambios">
                    Guardar Cambios
                </button>
                <button id="cancelSubjectBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="deleteSubjectsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="deleteModalTitle" class="text-2xl font-bold mb-4">Selecciona Materia a Eliminar</h2>
            <input type="hidden" id="deleteModalYear">
            <input type="hidden" id="deleteModalSemester">

            <!-- MODIFIED: Changed bg-gray-100 to a dynamic class -->
            <div id="deleteSubjectList" class="mb-4 space-y-2">
            </div>

            <div class="flex justify-end mt-6">
                <button id="cancelDeleteSubjectsBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="settingsModalTitle" class="text-2xl font-bold mb-4">Configuraci√≥n General</h2>

            <div class="mb-4">
                <label for="editCareerTitle" class="block text-sm font-bold mb-2">T√≠tulo de la Carrera:</label>
                <input type="text" id="editCareerTitle" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="mb-4">
                <label for="editTotalCareerCredits" class="block text-sm font-bold mb-2">Cr√©ditos Totales de la Carrera:</label>
                <input type="number" id="editTotalCareerCredits" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" min="1" required>
            </div>

            <div class="mb-4">
                <label for="editIntermediateTitleCredits" class="block text-sm font-bold mb-2">Cr√©ditos para T√≠tulo Intermedio:</label>
                <input type="number" id="editIntermediateTitleCredits" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" min="0" required>
            </div>

            <div class="flex justify-end mt-6">
                <button id="saveSettingsBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Configuraci√≥n">
                    Guardar Configuraci√≥n
                </button>
                <button id="cancelSettingsBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="alertdialog" aria-modal="true" aria-labelledby="alertModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/4 modal-content">
            <h3 id="alertModalTitle" class="text-xl font-bold mb-4"></h3>
            <p id="alertModalMessage" class="mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="alertModalConfirmBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 hidden" aria-label="Confirmar">
                    Confirmar
                </button>
                <button id="alertModalCloseBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="academicDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="academicDateDisplay">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 class="text-2xl font-bold mb-4"><span id="academicDateDisplay"></span></h2>
            <div id="eventsForSelectedDate" class="space-y-3">
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeAcademicDetailsModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar Detalles de Eventos">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="gradeStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="gradeStatusModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="gradeStatusModalTitle" class="text-2xl font-bold mb-4">Notas y Estado de Examen</h2>
            <input type="hidden" id="gradeStatusSubjectId">

            <div class="modal-inner-box">
                <label for="partial1GradeType" class="block text-sm font-bold mb-2">Tipo de Nota Primer Parcial:</label>
                <select id="partial1GradeType" class="grade-type-select shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"></select>
                <label for="partial1GradeValue" class="block text-sm font-bold mb-2 mt-2">Nota Primer Parcial:</label>
                <div id="partial1GradeValueContainer" class="flex items-center gap-2"></div>
                <div class="flex justify-center gap-4 mt-2">
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial1Indicator" data-indicator-type="check" aria-label="Marcar Primer Parcial como bien">‚úîÔ∏è</button>
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial1Indicator" data-indicator-type="tilde" aria-label="Marcar Primer Parcial como m√°s o menos">„ÄΩÔ∏è</button>
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial1Indicator" data-indicator-type="cross" aria-label="Marcar Primer Parcial como mal">‚ùåÔ∏è</button>
                </div>
                <span id="partial1Indicator" class="text-xl mt-1 block text-center"></span>
                <div class="mt-4">
                    <label for="inputPartial1Date" class="block text-sm font-bold mb-2">Fecha Primer Parcial:</label>
                    <input type="date" id="inputPartial1Date" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mt-4">
                    <label for="inputPartial1Time" class="block text-sm font-bold mb-2">Hora Primer Parcial:</label>
                    <input type="time" id="inputPartial1Time" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mt-4">
                    <label for="partial1Notes" class="block text-sm font-bold mb-2">Temas / Notas para Primer Parcial:</label>
                    <textarea id="partial1Notes" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Anotar temas, recordatorios, etc."></textarea>
                </div>
            </div>

            <div class="modal-inner-box">
                <label for="partial2GradeType" class="block text-sm font-bold mb-2">Tipo de Nota Segundo Parcial:</label>
                <select id="partial2GradeType" class="grade-type-select shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"></select>
                <label for="partial2GradeValue" class="block text-sm font-bold mb-2 mt-2">Nota Segundo Parcial:</label>
                <div id="partial2GradeValueContainer" class="flex items-center gap-2"></div>
                <div class="flex justify-center gap-4 mt-2">
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial2Indicator" data-indicator-type="check" aria-label="Marcar Segundo Parcial como bien">‚úîÔ∏è</button>
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial2Indicator" data-indicator-type="tilde" aria-label="Marcar Segundo Parcial como m√°s o menos">„ÄΩÔ∏è</button>
                    <button type="button" class="partial-indicator-btn text-2xl" data-target-indicator="partial2Indicator" data-indicator-type="cross" aria-label="Marcar Segundo Parcial como mal">‚ùåÔ∏è</button>
                </div>
                <span id="partial2Indicator" class="text-xl mt-1 block text-center"></span>
                <div class="mt-4">
                    <label for="inputPartial2Date" class="block text-sm font-bold mb-2">Fecha Segundo Parcial:</label>
                    <input type="date" id="inputPartial2Date" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mt-4">
                    <label for="inputPartial2Time" class="block text-sm font-bold mb-2">Hora Segundo Parcial:</label>
                    <input type="time" id="inputPartial2Time" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mt-4">
                    <label for="partial2Notes" class="block text-sm font-bold mb-2">Temas / Notas para Segundo Parcial:</label>
                    <textarea id="partial2Notes" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Anotar temas, recordatorios, etc."></textarea>
                </div>
            </div>

            <div class="modal-inner-box">
                <label for="finalAverageGradeType" class="block text-sm font-bold mb-2">Tipo de Promedio Final:</label>
                <select id="finalAverageGradeType" class="grade-type-select shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"></select>
                <label for="finalAverageGradeValue" class="block text-sm font-bold mb-2 mt-2">Promedio Final:</label>
                <div id="finalAverageGradeValueContainer" class="flex items-center gap-2"></div>
            </div>

            <div class="modal-inner-box">
                <label for="inputExamStatus" class="block text-sm font-bold mb-2">Estado de Examen:</label>
                <select id="inputExamStatus" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="No Definido">No Definido</option>
                    <option value="A Examen">A Examen</option>
                    <option value="Salvada">Salvada</option>
                </select>
                <div id="examDateTimeContainer" class="mt-4 hidden">
                    <div class="mb-4">
                        <label for="examGradeType" class="block text-sm font-bold mb-2">Tipo de Nota Examen Final:</label>
                        <select id="examGradeType" class="grade-type-select shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"></select>
                        <label for="examGradeValue" class="block text-sm font-bold mb-2 mt-2">Nota Examen Final:</label>
                        <div id="examGradeValueContainer" class="flex items-center gap-2"></div>
                    </div>
                    <div class="mb-4">
                        <label for="inputExamDate" class="block text-sm font-bold mb-2">Fecha Examen Final:</label>
                        <input type="date" id="inputExamDate" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label for="inputExamTime" class="block text-sm font-bold mb-2">Hora Examen Final:</label>
                        <input type="time" id="inputExamTime" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mt-4">
                        <label for="examNotes" class="block text-sm font-bold mb-2">Temas / Notas para Examen Final:</label>
                        <textarea id="examNotes" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Anotar temas, recordatorios, etc."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-inner-box">
                <div class="mb-4">
                    <label for="inputProfessor" class="block text-sm font-bold mb-2">Profesor:</label>
                    <input type="text" id="inputProfessor" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="inputZoomUrl" class="block text-sm font-bold mb-2">URL Zoom:</label>
                    <input type="url" id="inputZoomUrl" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="inputClassroom" class="block text-sm font-bold mb-2">Aula:</label>
                    <input type="text" id="inputClassroom" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="inputControlNumber" class="block text-sm font-bold mb-2">N√∫mero de Control:</label>
                    <input type="text" id="inputControlNumber" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button id="saveGradeStatusBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Notas y Estado">
                    Guardar
                </button>
                <button id="cancelGradeStatusBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="subjectInfoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="subjectInfoModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="subjectInfoModalTitle" class="text-2xl font-bold mb-4">Detalles de la Materia</h2>
            <div id="subjectInfoContent" class="space-y-3">
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeSubjectInfoModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar Detalles de Materia">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="addYearSemestersModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="addYearSemestersTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="addYearSemestersTitle" class="text-2xl font-bold mb-4">Seleccionar Semestres por A√±o</h2>
            <p class="mb-4">¬øCu√°ntos semestres quieres agregar a este nuevo a√±o acad√©mico?</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <label class="inline-flex items-center">
                    <input type="radio" name="numSemesters" value="1" class="form-radio text-blue-600 h-5 w-5" checked>
                    <span class="ml-2">1 Semestre</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="numSemesters" value="2" class="form-radio text-blue-600 h-5 w-5">
                    <span class="ml-2">2 Semestres</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="numSemesters" value="3" class="form-radio text-blue-600 h-5 w-5">
                    <span class="ml-2">3 Semestres</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="radio" name="numSemesters" value="4" class="form-radio text-blue-600 h-5 w-5">
                    <span class="ml-2">4 Semestres</span>
                </label>
            </div>

            <div class="flex justify-end mt-6">
                <button id="confirmAddSemestersBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Confirmar Semestres">
                    Confirmar
                </button>
                <button id="cancelAddSemestersBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="resourceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="resourceModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-2/3 lg:w-1/2 modal-content">
            <h2 id="resourceModalTitle" class="text-2xl font-bold mb-4">Recursos de la Materia</h2>
            <input type="hidden" id="resourceSubjectId">

            <div class="border-b border-gray-200">
                <nav class="-mb-px flex gap-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="summary">Resumen</button>
                    <button class="tab-button" data-tab="links">Enlaces</button>
                </nav>
            </div>

            <div id="summaryTab" class="tab-content active">
                <textarea id="summaryTextarea" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline h-64" placeholder="Escribe tu resumen aqu√≠..."></textarea>
            </div>
            <div id="linksTab" class="tab-content">
                <p class="text-sm mb-2">Guarda enlaces √∫tiles (videos, art√≠culos, etc.).</p>
                <input type="url" id="linkUrlInput" class="shadow border rounded w-full py-2 px-3 mb-2" placeholder="https://ejemplo.com">
                <button id="addLinkBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg">Agregar Enlace</button>
                <ul id="linkList" class="list-disc list-inside mt-4"></ul>
            </div>

            <div class="flex justify-end mt-6">
                <button id="saveResourcesBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar y Cerrar">
                    Guardar y Cerrar
                </button>
                <button id="cancelResourcesBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="goalsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal hidden" role="dialog" aria-modal="true" aria-labelledby="goalsModalTitle">
        <div class="p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="goalsModalTitle" class="text-2xl font-bold mb-4">Metas de Estudio</h2>

            <div class="mb-4">
                <label for="goalTextInput" class="block text-sm font-bold mb-2">Nueva Meta:</label>
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <input type="text" id="goalTextInput" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ej: Estudiar 5 horas de C√°lculo">
                        <select id="goalSubjectSelect" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" aria-label="Seleccionar materia para la meta"></select>
                    </div>
                    <button id="addGoalBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg h-10">+</button>
                </div>
            </div>

            <h3 class="text-lg font-semibold mt-6 mb-2">Metas Pendientes</h3>
            <div id="goalList" class="space-y-2 modal-inner-box">
            </div>

            <div class="flex justify-end mt-6">
                <button id="closeGoalsModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" aria-label="Cerrar">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden" role="status" aria-live="assertive">
        <div class="spinner"></div>
        <p>Generando PDF, por favor espera...</p>
    </div>

    <style id="custom-colors-style"></style>

    <script>
        let subjectsData = JSON.parse(localStorage.getItem('subjectsData')) || [];
        let completedSubjects = new Set(JSON.parse(localStorage.getItem('completedSubjects')) || []);
        let studyGoals = JSON.parse(localStorage.getItem('studyGoals')) || [];
        let careerSettings = JSON.parse(localStorage.getItem('careerSettings')) || {
            careerTitle: 'INSERTAR TITULO',
            totalCareerCredits: 0,
            intermediateTitleCredits: 0,
            completedCredits: 0
        };
        const defaultColorSettings = {
            headerBg: '#e0b0d0',
            yearCompleted: '#70a080',
            yearIncomplete: '#fcd34d',
            completedSubjectBg: '#d1e7dd',
            typeObligatoria: '#f6ad55',
            typeOpcional: '#48bb78',
            typeElectiva: '#ed64a6',
            navButtonBg: '#b0e0e6',
            navButtonText: '#2d3748',
            addButtonBg: '#4299e1',
            deleteButtonBg: '#e53e3e',
            addSubjectButtonBg: '#9f7aea',
            deleteSubjectsButtonBg: '#f56565',
            saveButtonBg: '#48bb78',
            downloadButtonBg: '#38a169',
            addScheduleButtonBg: '#4299e1'
        };
        let colorSettings = JSON.parse(localStorage.getItem('colorSettings')) || { ...defaultColorSettings };
        let isDarkMode = localStorage.getItem('darkMode') === 'true' || false;

        let currentActiveView = '';
        let currentCalendarDate = new Date();
        window.semesterCharts = window.semesterCharts || {};

        function generateUniqueId() { return `sub-${Date.now()}-${Math.floor(Math.random() * 1000)}`; }
        function getYearName(yearNum) { return `A√±o ${yearNum}`; }
        function findSubjectAndSemesterById(subjectId) {
            for (const semesterData of subjectsData) {
                const subject = semesterData.subjects.find(sub => sub.id === subjectId);
                if (subject) return { semester: semesterData, subject: subject };
            }
            return null;
        }
        function getSubjectById(subjectId) {
            for (const semesterData of subjectsData) {
                const subject = semesterData.subjects.find(sub => sub.id === subjectId);
                if (subject) return subject;
            }
            return null;
        }
        function toSpanishOrdinal(num) {
            switch (num) {
                case 1: return 'Primer';
                case 2: return 'Segundo';
                case 3: return 'Tercer';
                case 4: return 'Cuarto';
                default: return `${num}¬∫`;
            }
        }
        function generateNumericGradeOptions(selectedValue) {
            let optionsHtml = '<option value="">Sin nota</option>';
            for (let i = 0; i <= 12; i++) {
                optionsHtml += `<option value="${i}" ${selectedValue == i ? 'selected' : ''}>${i}</option>`;
            }
            return optionsHtml;
        }
        function generateConceptualGradeOptions(selectedValue, context) {
            const partialGrades = ['No Definido', 'MUY INSUFICIENTE (MI)', 'INSUFICIENTE (I)', 'SIN CONCEPTO (SC)', 'ACEPTABLE (A)', 'BUENO (B)', 'MUY BUENO (MB)', 'EXCELENTE (E)'];
            const finalGrades = ['No Definido', 'MUY INSUFICIENTE (MI)', 'INSUFICIENTE (I)', 'ACEPTABLE (A)', 'BUENO (B)', 'MUY BUENO (MB)', 'EXCELENTE (E)'];
            const grades = context === 'partial' ? partialGrades : finalGrades;
            let optionsHtml = '';
            grades.forEach(grade => {
                optionsHtml += `<option value="${grade}" ${selectedValue == grade ? 'selected' : ''}>${grade}</option>`;
            });
            return optionsHtml;
        }
        function generatePercentageGradeInput(selectedValue, inputId) {
            const value = (selectedValue === null || selectedValue === undefined || selectedValue === '') ? '' : Number(selectedValue);
            return `<input type="number" id="${inputId}" value="${value}" min="0" max="100" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">`;
        }
        function updateGradeInput(typeSelect, targetContainerId, gradeContext, initialValue) {
            const container = document.getElementById(targetContainerId + 'Container');
            const selectedType = typeSelect.value;
            const inputId = targetContainerId;
            let inputHtml = '';
            if (selectedType === 'Numerica') {
                inputHtml = `<select id="${inputId}" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">${generateNumericGradeOptions(initialValue)}</select>`;
            } else if (selectedType === 'Conceptual') {
                inputHtml = `<select id="${inputId}" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">${generateConceptualGradeOptions(initialValue, gradeContext)}</select>`;
            } else if (selectedType === 'Porcentaje') {
                inputHtml = generatePercentageGradeInput(initialValue, inputId);
            } else {
                inputHtml = `<input type="text" id="${inputId}" value="${initialValue || ''}" class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" disabled placeholder="Selecciona un tipo de nota">`;
            }
            container.innerHTML = inputHtml;
        }
        function updatePartialGradeIndicatorDisplay(indicatorId, selectedType) {
            const indicatorSpan = document.getElementById(indicatorId);
            let symbol = '';
            switch (selectedType) {
                case 'check': symbol = '‚úîÔ∏è'; break;
                case 'tilde': symbol = '„ÄΩÔ∏è'; break;
                case 'cross': symbol = '‚ùåÔ∏è'; break;
                default: symbol = '';
            }
            indicatorSpan.textContent = symbol;
            indicatorSpan.dataset.selectedType = selectedType;
        }

        function saveSubjectsData() { localStorage.setItem('subjectsData', JSON.stringify(subjectsData)); }
        function saveCompletedSubjects() { localStorage.setItem('completedSubjects', JSON.stringify(Array.from(completedSubjects))); }
        function saveCareerSettings() {
            localStorage.setItem('careerSettings', JSON.stringify(careerSettings));
            updateHeaderDisplay();
        }
        function saveColorSettings() { localStorage.setItem('colorSettings', JSON.stringify(colorSettings)); }
        function saveGoals() { localStorage.setItem('studyGoals', JSON.stringify(studyGoals)); }
        function saveDarkMode() { localStorage.setItem('darkMode', isDarkMode); }

        function recalculateCompletedCredits() {
            let totalCompletedCredits = 0;
            subjectsData.forEach(semesterData => {
                semesterData.subjects.forEach(subject => {
                    if (completedSubjects.has(subject.id)) {
                        totalCompletedCredits += subject.credits;
                    }
                });
            });
            careerSettings.completedCredits = totalCompletedCredits;
            saveCareerSettings();
            updateProgressBars();
        }
        function updateProgressBars() {
            const totalCareerCredits = careerSettings.totalCareerCredits;
            const intermediateTitleCredits = careerSettings.intermediateTitleCredits;
            const completed = careerSettings.completedCredits || 0;
            const totalProgressBar = document.getElementById('totalCreditsProgressBar');
            const totalPercentage = totalCareerCredits > 0 ? (completed / totalCareerCredits) * 100 : 0;
            totalProgressBar.style.width = `${totalPercentage}%`;
            totalProgressBar.textContent = `${completed}/${totalCareerCredits}`;
            const intermediateProgressBar = document.getElementById('intermediateTitleProgressBar');
            const intermediatePercentage = intermediateTitleCredits > 0 ? (completed / intermediateTitleCredits) * 100 : 0;
            intermediateProgressBar.style.width = `${intermediatePercentage}%`;
            intermediateProgressBar.textContent = `${completed}/${intermediateTitleCredits}`;
            document.getElementById('totalCareerCreditsDisplay').textContent = totalCareerCredits;
            document.getElementById('intermediateTitleCreditsDisplay').textContent = intermediateTitleCredits;
        }
        function calculateTotalAvailableCredits() {
            let totalPossibleCredits = 0;
            subjectsData.forEach(semesterData => {
                semesterData.subjects.forEach(subject => {
                    totalPossibleCredits += subject.credits;
                });
            });
            document.getElementById('totalAvailableCredits').textContent = totalPossibleCredits;
        }
        function updateHeaderDisplay() {
            document.getElementById('careerTitleDisplay').textContent = careerSettings.careerTitle;
            updateProgressBars();
        }
        function renderYearSelectionButtons() {
            const yearSelectionButtons = document.getElementById('yearSelectionButtons');
            yearSelectionButtons.innerHTML = '';
            const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                const getYearNumber = (yearName) => {
                    const match = yearName.match(/\d+/);
                    return match ? parseInt(match[0]) : Infinity;
                };
                return getYearNumber(a) - getYearNumber(b);
            });
            if (uniqueYears.length === 0) {
                // MODIFIED: Ensure this message is always in the correct color based on mode
                const messageText = isDarkMode ? "No hay a√±os acad√©micos para mostrar. Agrega un nuevo a√±o para empezar." : "No hay a√±os acad√©micos para mostrar. Agrega un nuevo a√±o para empezar.";
                document.getElementById('semesterContentArea').innerHTML = `<p class="text-center text-gray-500 mt-10">${messageText}</p>`;
                if (currentActiveView !== 'Calendario Lectivo' && currentActiveView !== 'Camino Acad√©mico') {
                    currentActiveView = '';
                }
                return;
            }
            uniqueYears.forEach(year => {
                const button = document.createElement('button');
                button.className = `year-button ${currentActiveView === year ? 'active' : ''}`;
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-selected', currentActiveView === year ? 'true' : 'false');
                const yearSubjects = subjectsData.filter(s => s.year === year).flatMap(s => s.subjects);
                const allSubjectsInYearCompleted = yearSubjects.length > 0 && yearSubjects.every(subject => completedSubjects.has(subject.id));
                button.classList.add(allSubjectsInYearCompleted ? 'year-completed' : 'year-incomplete');
                button.textContent = year;
                button.onclick = () => showContent(year);
                yearSelectionButtons.appendChild(button);
            });
            if (!currentActiveView || (!uniqueYears.includes(currentActiveView) && currentActiveView !== 'Calendario Lectivo' && currentActiveView !== 'Camino Acad√©mico')) {
                if (uniqueYears.length > 0) {
                    showContent(uniqueYears[0]);
                } else {
                    currentActiveView = '';
                }
            }
        }

        // MODIFICADO: Se ajust√≥ la funci√≥n para mostrar el semestre progresivo y el semestre dentro del a√±o.
        function showContent(yearToShow) {
            currentActiveView = yearToShow;
            document.getElementById('calendarWrapper').classList.add('hidden');
            document.getElementById('academicPathWrapper').classList.add('hidden');
            document.getElementById('calendarMainButton').classList.remove('active');
            document.getElementById('academicPathButton').classList.remove('active');

            const semesterContentArea = document.getElementById('semesterContentArea');
            semesterContentArea.classList.remove('hidden');
            semesterContentArea.innerHTML = '';

            for (const chartId in window.semesterCharts) {
                if (window.semesterCharts.hasOwnProperty(chartId)) {
                    window.semesterCharts[chartId].destroy();
                }
            }
            window.semesterCharts = {};

            const semestersInYear = subjectsData.filter(data => data.year === yearToShow).sort((a, b) => parseInt(a.semester) - parseInt(b.semester));
            semestersInYear.forEach((semesterData, index) => {
                const semesterSection = document.createElement('div');
                semesterSection.id = `semester-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`;
                semesterSection.className = 'semester-section mb-8';

                // Se calcula el n√∫mero de semestre dentro del a√±o (sumando 1 al √≠ndice)
                const inYearSemesterNumber = index + 1;
                const inYearSemesterOrdinal = toSpanishOrdinal(inYearSemesterNumber);

                semesterSection.innerHTML = `
                    <div class="flex justify-between items-start mb-4 flex-wrap gap-y-2">
                        <div>
                            <h2 class="text-lg font-bold">Semestre ${semesterData.semester}</h2>
                            <p class="sub-semester-label">${inYearSemesterOrdinal} Semestre del ${semesterData.year}</p>
                        </div>
                        <div class="flex gap-2 items-center flex-shrink-0">
                            <button class="add-subject-btn semester-action-btn" data-year="${semesterData.year}" data-semester="${semesterData.semester}" aria-label="Agregar Materia" title="Agregar Materia">+</button>
                            <button class="delete-subjects-btn semester-action-btn" data-year="${semesterData.year}" data-semester="${semesterData.semester}" aria-label="Eliminar Materias" title="Eliminar Materias">üóëÔ∏è</button>
                            <button class="download-schedule-btn text-white rounded-lg semester-action-btn" data-year="${semesterData.year}" data-semester="${semesterData.semester}" aria-label="Descargar Horario" title="Descargar Horario">üì§</button>
                        </div>
                    </div>
                    <div id="subjectList-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="mb-6"></div>
                    <div class="semester-credits-total">Total Cr√©ditos Semestre: <span id="semesterCredits-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}">0</span></div>
                    <div class="mt-8"><h3 class="text-xl font-semibold mb-3">Carga Horaria Semanal por Tipo</h3><div class="relative h-64 w-full"><canvas id="typeChart-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}"></canvas></div></div>
                    <div class="mt-8"><h3 class="text-xl font-semibold mb-3">Carga Horaria Diaria</h3><div id="dailyLoadContainer-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="flex flex-wrap justify-center gap-4"></div></div>
                    <div class="total-weekly-hours">Total Horas Semanales del Semestre: <span id="totalWeeklyHours-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}">0.0h</span></div>
                    <h3 class="text-xl font-semibold mt-8 mb-3">Horario del Semestre:</h3>
                    <div class="overflow-x-auto"><table id="scheduleTable-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="schedule-table"><thead><tr><th>Hora</th><th>Lunes</th><th>Martes</th><th>Mi√©rcoles</th><th>Jueves</th><th>Viernes</th><th>S√°bado</th><th>Domingo</th></tr></thead><tbody></tbody></table></div>`;
                semesterContentArea.appendChild(semesterSection);
                semesterSection.querySelector('.add-subject-btn').onclick = (event) => openAddSubjectModal(event.currentTarget.dataset.year, event.currentTarget.dataset.semester);
                semesterSection.querySelector('.delete-subjects-btn').onclick = (event) => openDeleteSubjectsModal(event.currentTarget.dataset.year, event.currentTarget.dataset.semester);
                semesterSection.querySelector('.download-schedule-btn').onclick = (event) => generateSemesterPDF(event.currentTarget.dataset.year, event.currentTarget.dataset.semester);
                populateSubjectList(semesterData);
                populateScheduleTable(semesterData);
                renderDonutChart(`typeChart-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`, getSemesterTypeHours(semesterData.subjects));
                renderDailyLoadBoxes(`dailyLoadContainer-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`, getSemesterDailyHours(semesterData.subjects));
                document.getElementById(`totalWeeklyHours-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`).textContent = `${calculateSemesterTotalWeeklyHours(semesterData.subjects).toFixed(1)}h`;
            });
            document.querySelectorAll('.year-button').forEach(btn => btn.classList.toggle('active', btn.textContent === yearToShow));
        }

        function populateSubjectList(semesterData) {
            const subjectListDiv = document.getElementById(`subjectList-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`);
            subjectListDiv.innerHTML = '';
            let semesterTotalCredits = 0;
            const allCompletedSubjectIds = new Set(Array.from(completedSubjects));
            if (semesterData.subjects.length === 0) {
                const messageText = isDarkMode ? "No hay materias en este semestre. Haz clic en '+' para agregar una." : "No hay materias en este semestre. Haz clic en '+' para agregar una.";
                subjectListDiv.innerHTML = `<p class="text-center text-gray-500 mt-4">${messageText}</p>`;
            }
            semesterData.subjects.forEach(subject => {
                const isCompleted = allCompletedSubjectIds.has(subject.id);
                semesterTotalCredits += subject.credits;
                const hasUnmetPrevia = subject.previas.some(previaId => !allCompletedSubjectIds.has(previaId));
                const subjectItem = document.createElement('div');
                subjectItem.className = `subject-item ${hasUnmetPrevia ? 'previa-unmet' : ''} type-${subject.type} ${isCompleted ? 'is-completed' : ''}`;
                subjectItem.innerHTML = `
                    <div class="subject-item-main-content">
                        <input type="checkbox" class="subject-checkbox" data-subject-id="${subject.id}" ${isCompleted ? 'checked' : ''} ${hasUnmetPrevia ? 'disabled' : ''}>
                        <div class="subject-details">
                            <span class="subject-name ${isCompleted ? 'completed' : ''}" data-subject-id="${subject.id}">${subject.name}</span>
                            <!-- NUEVO: Contenedor para los recuadros de informaci√≥n -->
                            <div class="subject-credits-and-code flex items-center gap-2 flex-wrap">
                                <span class="subject-info-tag">${subject.credits} cr√©ditos</span>
                                ${subject.scheduleCode !== null ? `<span class="subject-info-tag">Cod. Horario: ${subject.scheduleCode}</span>` : ''}
                                ${subject.assignedCode ? `<span class="subject-info-tag">Cod. Asignado: ${subject.assignedCode}</span>` : ''}
                            </div>
                        </div>
                        <div class="subject-tags">
                            <span class="subject-type type-${subject.type}">${subject.type}</span>
                            <span class="delivery-type delivery-type-${subject.deliveryType.replace(/\s/g, '')}">${subject.deliveryType}</span>
                        </div>
                        <div class="subject-icons">
                            <span class="grade-status-trigger" data-subject-id="${subject.id}" title="Notas y Estado">üìù</span>
                            <span class="subject-info-trigger" data-subject-id="${subject.id}" title="Ver Detalles">‚ÑπÔ∏è</span>
                        </div>
                    </div>
                    <button class="summary-button" data-subject-id="${subject.id}">Recursos</button>`;
                subjectListDiv.appendChild(subjectItem);
            });
            document.getElementById(`semesterCredits-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`).textContent = semesterTotalCredits;
            subjectListDiv.querySelectorAll('.subject-checkbox').forEach(checkbox => {
                checkbox.onchange = (event) => {
                    const subjectId = event.target.dataset.subjectId;
                    event.target.checked ? completedSubjects.add(subjectId) : completedSubjects.delete(subjectId);
                    saveCompletedSubjects();
                    recalculateCompletedCredits();
                    showContent(currentActiveView);
                    renderYearSelectionButtons();
                };
            });
            subjectListDiv.querySelectorAll('.subject-name').forEach(nameSpan => nameSpan.onclick = (event) => openEditSubjectModal(event.target.dataset.subjectId));
            subjectListDiv.querySelectorAll('.grade-status-trigger').forEach(trigger => trigger.onclick = (event) => openGradeStatusModal(event.target.dataset.subjectId));
            subjectListDiv.querySelectorAll('.subject-info-trigger').forEach(trigger => trigger.onclick = (event) => openSubjectInfoModal(event.target.dataset.subjectId));
            subjectListDiv.querySelectorAll('.summary-button').forEach(button => button.onclick = (event) => openResourceModal(event.target.dataset.subjectId));
        }
        function updateSemesterOverlaps(semesterData) {
            semesterData.subjects.forEach(subject => {
                // Ensure every slot has an `overlap` property initialized to false
                subject.schedule.forEach(slot => slot.overlap = false);
            });

            const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            daysOfWeek.forEach(day => {
                const daySlots = [];
                semesterData.subjects.forEach(subject => {
                    subject.schedule.filter(slot => slot.day === day).forEach(slot => {
                        daySlots.push({
                            subjectId: subject.id,
                            slot: slot
                        });
                    });
                });

                daySlots.sort((a, b) => {
                    const timeA = new Date(`1970-01-01T${a.slot.start}`);
                    const timeB = new Date(`1970-01-01T${b.slot.start}`);
                    return timeA - timeB;
                });

                for (let i = 0; i < daySlots.length; i++) {
                    for (let j = i + 1; j < daySlots.length; j++) {
                        const slot1 = daySlots[i].slot;
                        const slot2 = daySlots[j].slot;
                        const start1 = new Date(`2000/01/01T${slot1.start}`);
                        const end1 = new Date(`2000/01/01T${slot1.end}`);
                        const start2 = new Date(`2000/01/01T${slot2.start}`);
                        const end2 = new Date(`2000/01/01T${slot2.end}`);

                        if (start1 < end2 && end1 > start2) {
                            slot1.overlap = true;
                            slot2.overlap = true;
                        }
                    }
                }
            });
        }
        function populateScheduleTable(semesterData, tableId = null) {
            const targetTableId = tableId || `scheduleTable-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`;
            const scheduleTableBody = document.getElementById(targetTableId)?.querySelector('tbody');
            if (!scheduleTableBody) return;
            scheduleTableBody.innerHTML = '';

            updateSemesterOverlaps(semesterData);

            const timeSlots = {};
            for (let h = 8; h < 23; h++) {
                const start = `${String(h).padStart(2, '0')}:00`;
                const end = `${String(h + 1).padStart(2, '0')}:00`;
                timeSlots[`${start}-${end}`] = { display: `${start} - ${end}`, days: { 'Lunes': [], 'Martes': [], 'Mi√©rcoles': [], 'Jueves': [], 'Viernes': [], 'S√°bado': [], 'Domingo': [] } };
            }

            semesterData.subjects.forEach(subject => {
                subject.schedule.forEach(slot => {
                    for (const slotKey in timeSlots) {
                        const [intervalStart, intervalEnd] = slotKey.split('-');
                        if (slot.start < intervalEnd && slot.end > intervalStart) {
                             const subjectDetails = {
                                id: subject.id,
                                name: subject.name,
                                type: subject.type,
                                scheduleCode: subject.scheduleCode,
                                start: slot.start,
                                end: slot.end,
                                assignedCode: subject.assignedCode,
                                overlap: slot.overlap
                            };
                            timeSlots[slotKey].days[slot.day].push(subjectDetails);
                        }
                    }
                });
            });

            for (const slotKey in timeSlots) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="schedule-time">${timeSlots[slotKey].display}</td>`;
                ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].forEach(day => {
                    const cell = document.createElement('td');
                    const entries = timeSlots[slotKey].days[day];
                    const uniqueEntries = Array.from(new Set(entries.map(e => JSON.stringify(e)))).map(e => JSON.parse(e));
                    uniqueEntries.forEach(entry => {
                        const isOverlap = entry.overlap;
                        const entryDiv = document.createElement('div');
                        entryDiv.className = `schedule-entry type-${entry.type} ${isOverlap ? 'overlap' : ''}`;
                        entryDiv.textContent = entry.name + (entry.assignedCode ? ` (Cod. Asig: ${entry.assignedCode})` : '') + (entry.scheduleCode !== null ? ` (Cod. Hor: ${entry.scheduleCode})` : '');
                        cell.appendChild(entryDiv);
                    });
                    row.appendChild(cell);
                });
                scheduleTableBody.appendChild(row);
            }
        }
        function getAcademicEvents(futureOnly = false, month = null, year = null) {
            const events = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            subjectsData.forEach(yearSemester => {
                yearSemester.subjects.forEach(subject => {
                    const checkAndPush = (eventType, date, time) => {
                        if (date) {
                            const eventDate = new Date(date + 'T12:00:00');
                            if ((!futureOnly || eventDate >= today) && (month === null || eventDate.getMonth() === month) && (year === null || eventDate.getFullYear() === year)) {
                                events.push({ subjectId: subject.id, name: subject.name, eventType, eventDate: date, eventTime: time, professor: subject.professor, zoomUrl: subject.zoomUrl, classroom: subject.classroom });
                            }
                        }
                    };
                    checkAndPush('Primer Parcial', subject.partial1Date, subject.partial1Time);
                    checkAndPush('Segundo Parcial', subject.partial2Date, subject.partial2Time);
                    if (subject.examStatus === 'A Examen') {
                        checkAndPush('Examen Final', subject.examDate, subject.examTime);
                    }
                });
            });
            return events.sort((a, b) => new Date(a.eventDate + (a.eventTime ? `T${a.eventTime}` : 'T00:00:00')) - new Date(b.eventDate + (b.eventTime ? `T${b.eventTime}` : 'T00:00:00')));
        }
        function populateCalendarYearSelect() {
            const calendarYearSelect = document.getElementById('calendarYearSelect');
            calendarYearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentCalendarDate.getFullYear()) option.selected = true;
                calendarYearSelect.appendChild(option);
            }
            calendarYearSelect.onchange = (event) => {
                currentCalendarDate.setFullYear(parseInt(event.target.value));
                renderAcademicCalendar();
            };
        }
        function renderAcademicCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            const currentMonth = currentCalendarDate.getMonth();
            const currentYear = currentCalendarDate.getFullYear();
            document.getElementById('currentMonthYear').textContent = currentCalendarDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const numDaysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startOffset = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;
            ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'].forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            for (let i = 0; i < startOffset; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            const academicEventsForMonth = getAcademicEvents(false, currentMonth, currentYear);
            const academicEventsByDate = {};
            academicEventsForMonth.forEach(event => {
                if (!academicEventsByDate[event.eventDate]) academicEventsByDate[event.eventDate] = [];
                academicEventsByDate[event.eventDate].push(event);
            });
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (academicEventsByDate[dateString]) {
                    dayDiv.classList.add('has-exam');
                    const eventCount = document.createElement('div');
                    eventCount.className = 'exam-indicator';
                    eventCount.textContent = academicEventsByDate[dateString].length;
                    dayDiv.appendChild(eventCount);
                    dayDiv.onclick = () => openAcademicDetailsModalForDay(dateString, academicEventsByDate[dateString]);
                } else {
                    dayDiv.onclick = () => showCustomAlert('Sin Eventos', `No hay eventos programados para el ${day}/${currentMonth + 1}/${currentYear}.`);
                }
                calendarGrid.appendChild(dayDiv);
            }
        }
        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAcademicCalendar();
        }
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAcademicCalendar();
        }
        function openAcademicDetailsModalForDay(dateString, events) {
            document.getElementById('academicDateDisplay').textContent = `Eventos para el ${new Date(dateString + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            const eventsForSelectedDate = document.getElementById('eventsForSelectedDate');
            eventsForSelectedDate.innerHTML = '';
            if (events && events.length > 0) {
                events.forEach(event => {
                    const eventDetailDiv = document.createElement('div');
                    eventDetailDiv.className = 'modal-inner-box';
                    eventDetailDiv.innerHTML = `<p class="font-semibold text-lg">${event.name} - ${event.eventType} ${event.eventTime ? `(${event.eventTime})` : ''}</p><p class="text-sm text-gray-600">Profesor: ${event.professor || 'N/A'}</p>${event.zoomUrl ? `<p class="text-sm text-gray-600">Zoom: <a href="${event.zoomUrl}" target="_blank" class="text-blue-600 hover:underline">Enlace</a></p>` : ''}${event.classroom ? `<p class="text-sm text-gray-600">Aula: ${event.classroom}</p>` : ''}`;
                    eventsForSelectedDate.appendChild(eventDetailDiv);
                });
            } else {
                eventsForSelectedDate.innerHTML = '<p class="text-gray-500">No hay eventos programados para esta fecha.</p>';
            }
            document.getElementById('academicDetailsModal').classList.remove('hidden');
        }
        function lightenColor(hex, percent) {
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            r = Math.min(255, r + (255 - r) * percent / 100);
            g = Math.min(255, g + (255 - g) * percent / 100);
            b = Math.min(255, b + (255 - b) * percent / 100);
            const rr = Math.round(r).toString(16).padStart(2, '0');
            const gg = Math.round(g).toString(16).padStart(2, '0');
            const bb = Math.round(b).toString(16).padStart(2, '0');
            return `#${rr}${gg}${bb}`;
        }
        function applyCustomColors() {
            const styleTag = document.getElementById('custom-colors-style');
            const darkenColor = (hex, percent) => {
                let r = parseInt(hex.substring(1, 3), 16);
                let g = parseInt(hex.substring(3, 5), 16);
                let b = parseInt(hex.substring(5, 7), 16);
                r = parseInt(r * (100 - percent) / 100);
                g = parseInt(g * (100 - percent) / 100);
                b = parseInt(b * (100 - percent) / 100);
                r = (r < 255) ? r : 255;
                g = (g < 255) ? g : 255;
                b = (b < 255) ? b : 255;
                const rr = r.toString(16).length == 1 ? "0" + r.toString(16) : r.toString(16);
                const gg = g.toString(16).length == 1 ? "0" + g.toString(16) : g.toString(16);
                const bb = b.toString(16).length == 1 ? "0" + b.toString(16) : b.toString(16);
                return `#${rr}${gg}${bb}`;
            };

            styleTag.innerHTML = `
                .header { background-color: ${colorSettings.headerBg}; }
                .year-button.year-completed { background-color: ${colorSettings.yearCompleted}; }
                .year-button.year-incomplete { background-color: ${colorSettings.yearIncomplete}; }
                .subject-item.type-Obligatoria { border-left-color: ${colorSettings.typeObligatoria}; }
                .subject-item.type-Opcional { border-left-color: ${colorSettings.typeOpcional}; }
                .subject-item.type-Electiva { border-left-color: ${colorSettings.typeElectiva}; }
                .subject-item.is-completed { background-color: ${colorSettings.completedSubjectBg}; }

                .schedule-entry.type-Obligatoria { border-left-color: ${colorSettings.typeObligatoria}; }
                .schedule-entry.type-Opcional { border-left-color: ${colorSettings.typeOpcional}; }
                .schedule-entry.type-Electiva { border-left-color: ${colorSettings.typeElectiva}; }

                .calendar-main-button { background-color: ${colorSettings.navButtonBg}; color: ${colorSettings.navButtonText}; }
                .calendar-main-button:hover { background-color: ${darkenColor(colorSettings.navButtonBg, 10)}; }
                .calendar-main-button.active { background-color: ${darkenColor(colorSettings.navButtonBg, 20)}; color: white; }
                #addYearBtn { background-color: ${colorSettings.addButtonBg}; }
                #addYearBtn:hover { background-color: ${darkenColor(colorSettings.addButtonBg, 10)}; }
                #removeYearBtn { background-color: ${colorSettings.deleteButtonBg}; }
                #removeYearBtn:hover { background-color: ${darkenColor(colorSettings.deleteButtonBg, 10)}; }
                .add-subject-btn { background-color: ${colorSettings.addSubjectButtonBg}; }
                .add-subject-btn:hover { background-color: ${darkenColor(colorSettings.addSubjectButtonBg, 10)}; }
                .delete-subjects-btn { background-color: ${colorSettings.deleteSubjectsButtonBg}; }
                .delete-subjects-btn:hover { background-color: ${darkenColor(colorSettings.deleteSubjectsButtonBg, 10)}; }

                #saveSubjectBtn { background-color: ${colorSettings.saveButtonBg}; }
                #saveSubjectBtn:hover { background-color: ${darkenColor(colorSettings.saveButtonBg, 10)}; }
                .download-schedule-btn { background-color: ${colorSettings.downloadButtonBg}; }
                .download-schedule-btn:hover { background-color: ${darkenColor(colorSettings.downloadButtonBg, 10)}; }
                #addScheduleSlotBtn { background-color: ${colorSettings.addScheduleButtonBg}; }
                #addScheduleSlotBtn:hover { background-color: ${darkenColor(colorSettings.addScheduleButtonBg, 10)}; }

                .path-node.type-Obligatoria { background-color: ${colorSettings.typeObligatoria}; border-color: ${darkenColor(colorSettings.typeObligatoria, 20)}; color: white; }
                .path-node.type-Opcional { background-color: ${colorSettings.typeOpcional}; border-color: ${darkenColor(colorSettings.typeOpcional, 20)}; color: white; }
                .path-node.type-Electiva { background-color: ${colorSettings.typeElectiva}; border-color: ${darkenColor(colorSettings.typeElectiva, 20)}; color: white; }
                .path-node.completed { background-color: ${colorSettings.completedSubjectBg} !important; border-color: ${darkenColor(colorSettings.completedSubjectBg, 20)} !important; color: black !important; }

                /* NUEVO: Recuadros de informaci√≥n de la materia */
                .subject-item.type-Obligatoria .subject-info-tag { background-color: ${lightenColor(colorSettings.typeObligatoria, 30)}; color: black; border: 1px solid rgba(0,0,0,0.1); }
                .subject-item.type-Opcional .subject-info-tag { background-color: ${lightenColor(colorSettings.typeOpcional, 30)}; color: black; border: 1px solid rgba(0,0,0,0.1); }
                .subject-item.type-Electiva .subject-info-tag { background-color: ${lightenColor(colorSettings.typeElectiva, 30)}; color: black; border: 1px solid rgba(0,0,0,0.1); }
                .dark-mode .subject-item.type-Obligatoria .subject-info-tag { background-color: ${colorSettings.typeObligatoria}; color: white; border: none; }
                .dark-mode .subject-item.type-Opcional .subject-info-tag { background-color: ${colorSettings.typeOpcional}; color: white; border: none; }
                .dark-mode .subject-item.type-Electiva .subject-info-tag { background-color: ${colorSettings.typeElectiva}; color: white; border: none; }
            `;
        }
        function populateColorPaletteInputs() {
            for (const key in colorSettings) {
                const colorInput = document.querySelector(`#colorPalettePanel input[type="color"][data-key="${key}"]`);
                const hexInput = document.querySelector(`#colorPalettePanel input[type="text"][data-key="${key}"]`);
                if (colorInput && hexInput) {
                    colorInput.value = colorSettings[key];
                    hexInput.value = colorSettings[key];
                }
            }
        }
        function openResourceModal(subjectId) {
            const subject = getSubjectById(subjectId);
            if (!subject) return;
            document.getElementById('resourceModalTitle').textContent = `Recursos de: ${subject.name}`;
            document.getElementById('resourceSubjectId').value = subjectId;

            if (!subject.resources) {
                subject.resources = { summary: '', links: [] };
            }

            document.getElementById('summaryTextarea').value = subject.resources.summary || '';

            const linkList = document.getElementById('linkList');
            linkList.innerHTML = '';
            (subject.resources.links || []).forEach((link, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                li.innerHTML = `<a href="${link}" target="_blank" class="text-blue-600 hover:underline">${link}</a><button class="text-red-500 font-bold" data-index="${index}" data-type="links">&times;</button>`;
                linkList.appendChild(li);
            });

            document.getElementById('resourceModal').classList.remove('hidden');
            switchTab('summary');
        }
        function closeResourceModal() { document.getElementById('resourceModal').classList.add('hidden'); }
        function saveResources() {
            const subjectId = document.getElementById('resourceSubjectId').value;
            const subject = getSubjectById(subjectId);
            if (subject) {
                subject.resources.summary = document.getElementById('summaryTextarea').value;
                saveSubjectsData();
                closeResourceModal();
                showCustomAlert('Guardado', 'Los recursos han sido guardados.');
            }
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
        }
        function addLink() {
            const subjectId = document.getElementById('resourceSubjectId').value;
            const subject = getSubjectById(subjectId);
            const linkUrlInput = document.getElementById('linkUrlInput');
            if (subject && linkUrlInput.value.trim()) {
                subject.resources.links.push(linkUrlInput.value.trim());
                linkUrlInput.value = '';
                openResourceModal(subjectId);
            }
        }
        function deleteResourceItem(subjectId, type, index) {
            const subject = getSubjectById(subjectId);
            if(subject && subject.resources && subject.resources[type]) {
                subject.resources[type].splice(index, 1);
                saveSubjectsData();
                openResourceModal(subjectId);
            }
        }
        function openGoalsModal() {
            const subjectSelect = document.getElementById('goalSubjectSelect');
            subjectSelect.innerHTML = '<option value="">(Sin Materia)</option>';
            const allSubjects = subjectsData.flatMap(sem => sem.subjects);
            allSubjects.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.name;
                subjectSelect.appendChild(option);
            });

            renderGoals();
            document.getElementById('goalsModal').classList.remove('hidden');
        }
        function closeGoalsModal() { document.getElementById('goalsModal').classList.add('hidden'); }
        function renderGoals() {
            const goalList = document.getElementById('goalList');
            goalList.innerHTML = '';
            studyGoals.forEach((goal, index) => {
                const item = document.createElement('div');
                item.className = 'goal-item flex justify-between items-center';
                const associatedSubject = getSubjectById(goal.subjectId);
                const subjectName = associatedSubject ? associatedSubject.name : 'N/A';

                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <input type="checkbox" data-index="${index}" ${goal.completed ? 'checked' : ''}>
                        <span class="${goal.completed ? 'completed' : ''}">${goal.text} <span class="text-sm text-gray-500">(${subjectName})</span></span>
                    </div>
                    <button class="text-red-500 font-bold" data-index="${index}">&times;</button>
                `;
                goalList.appendChild(item);
            });
        }
        function addGoal() {
            const input = document.getElementById('goalTextInput');
            const subjectId = document.getElementById('goalSubjectSelect').value;
            if (input.value.trim()) {
                studyGoals.push({ text: input.value.trim(), completed: false, subjectId: subjectId });
                input.value = '';
                document.getElementById('goalSubjectSelect').value = '';
                saveGoals();
                renderGoals();
            }
        }
        function deleteGoal(index) {
            studyGoals.splice(index, 1);
            saveGoals();
            renderGoals();
        }
        function toggleGoalStatus(index) {
            studyGoals[index].completed = !studyGoals[index].completed;
            saveGoals();
            renderGoals();
        }
        // MODIFICADO: L√≥gica para mostrar el semestre progresivo y dentro del a√±o.
        function showAcademicPath() {
            currentActiveView = 'Camino Acad√©mico';
            document.getElementById('calendarWrapper').classList.add('hidden');
            document.getElementById('semesterContentArea').classList.add('hidden');
            document.getElementById('academicPathWrapper').classList.remove('hidden');
            document.getElementById('calendarMainButton').classList.remove('active');
            document.getElementById('academicPathButton').classList.add('active');
            document.querySelectorAll('.year-button').forEach(btn => btn.classList.remove('active'));
            renderAcademicPath();
        }
        function renderAcademicPath() {
            const container = document.getElementById('pathContainer');
            const connectorsContainer = document.getElementById('pathConnectors');
            container.innerHTML = '';
            connectorsContainer.innerHTML = '';

            const allSubjects = subjectsData.flatMap(s => s.subjects.map(sub => ({...sub, year: s.year, semester: s.semester})));
            const groupedByYear = subjectsData.reduce((acc, curr) => {
                if (!acc[curr.year]) acc[curr.year] = [];
                acc[curr.year].push(curr);
                return acc;
            }, {});

            Object.keys(groupedByYear).sort((a, b) => parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0])).forEach(year => {
                const yearSemesters = groupedByYear[year].sort((a,b) => parseInt(a.semester) - parseInt(b.semester));
                yearSemesters.forEach((sem, index) => {
                    const col = document.createElement('div');
                    col.className = 'path-semester-col';
                    const inYearSemesterOrdinal = toSpanishOrdinal(index + 1);
                    col.innerHTML = `<div class="path-semester-title">${sem.year}<br>Semestre ${sem.semester}<br>(${inYearSemesterOrdinal} del a√±o)</div>`;
                    sem.subjects.forEach(sub => {
                        const node = document.createElement('div');
                        node.className = 'path-node';
                        node.classList.add(`type-${sub.type}`);
                        node.id = `path-node-${sub.id}`;
                        node.textContent = sub.name;
                        if (completedSubjects.has(sub.id)) {
                            node.classList.add('completed');
                        }
                        col.appendChild(node);
                    });
                    container.appendChild(col);
                });
            });


            setTimeout(() => {
                allSubjects.forEach(subject => {
                    if (subject.previas && subject.previas.length > 0) {
                        const targetNode = document.getElementById(`path-node-${subject.id}`);
                        const previaId = subject.previas[0];
                        const sourceNode = document.getElementById(`path-node-${previaId}`);
                        if (sourceNode && targetNode) {
                            const rect1 = sourceNode.getBoundingClientRect();
                            const rect2 = targetNode.getBoundingClientRect();
                            const containerRect = container.getBoundingClientRect();

                            const x1 = rect1.left + rect1.width / 2 - containerRect.left + container.scrollLeft;
                            const y1 = rect1.top + rect1.height / 2 - containerRect.top;
                            const x2 = rect2.left + rect2.width / 2 - containerRect.left + container.scrollLeft;
                            const y2 = rect2.top + rect2.height / 2 - containerRect.top;

                            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                            const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

                            const connector = document.createElement('div');
                            connector.className = 'path-connector';
                            connector.style.width = `${distance}px`;
                            connector.style.left = `${x1}px`;
                            connector.style.top = `${y1}px`;
                            connector.style.transform = `rotate(${angle}deg)`;
                            connectorsContainer.appendChild(connector);
                        }
                    }
                });
            }, 100);
        }
        // MODIFICADO: L√≥gica para agregar un nuevo a√±o y semestres con numeraci√≥n progresiva.
        function addYear() {
            const numSemestersToAdd = parseInt(document.querySelector('input[name="numSemesters"]:checked').value);
            const existingYears = subjectsData.map(d => parseInt(d.year.match(/\d+/)[0]));
            const newYearNum = existingYears.length > 0 ? Math.max(...existingYears) + 1 : 1;
            const newYearName = getYearName(newYearNum);

            // Obtiene el n√∫mero del √∫ltimo semestre existente. Si no hay, comienza en 0.
            const existingSemesterNumbers = subjectsData.map(d => parseInt(d.semester));
            const lastSemesterNumber = existingSemesterNumbers.length > 0 ? Math.max(...existingSemesterNumbers) : 0;

            for (let i = 1; i <= numSemestersToAdd; i++) {
                const newSemesterNumber = lastSemesterNumber + i;
                subjectsData.push({ year: newYearName, semester: `${newSemesterNumber}`, subjects: [] });
            }
            saveSubjectsData();
            renderYearSelectionButtons();
            showContent(newYearName);
            document.getElementById('addYearSemestersModal').classList.add('hidden');
        }
        function removeCurrentYear() {
            if (!currentActiveView || currentActiveView === 'Calendario Lectivo' || currentActiveView === 'Camino Acad√©mico') {
                showCustomAlert('Error', 'Por favor, selecciona un a√±o acad√©mico para eliminar.');
                return;
            }

            showCustomAlert('Confirmar Eliminaci√≥n', `¬øEst√°s seguro de que quieres eliminar "${currentActiveView}"? Todos los a√±os posteriores se reordenar√°n. Esta acci√≥n no se puede deshacer.`, true, () => {
                const yearToDeleteMatch = currentActiveView.match(/\d+/);
                if (!yearToDeleteMatch) {
                    subjectsData = subjectsData.filter(d => d.year !== currentActiveView);
                } else {
                    const yearNumToDelete = parseInt(yearToDeleteMatch[0]);
                    subjectsData = subjectsData.filter(d => d.year !== currentActiveView);
                    subjectsData.forEach(semesterData => {
                        const semesterYearMatch = semesterData.year.match(/\d+/);
                        if (semesterYearMatch) {
                            const semesterYearNum = parseInt(semesterYearMatch[0]);
                            if (semesterYearNum > yearNumToDelete) {
                                const newYearNum = semesterYearNum - 1;
                                semesterData.year = getYearName(newYearNum);
                            }
                        }
                    });
                }
                saveSubjectsData();
                currentActiveView = '';
                renderYearSelectionButtons();
                recalculateCompletedCredits();
                calculateTotalAvailableCredits();
            });
        }
        // MODIFICADO: El t√≠tulo del modal ahora incluye el semestre progresivo y el semestre dentro del a√±o.
        function openAddSubjectModal(year, semester) {
            const inYearSemesterNumber = subjectsData.filter(s => s.year === year).findIndex(s => s.semester === semester) + 1;
            document.getElementById('modalTitle').textContent = `Agregar Materia a ${year} - Semestre ${semester} (${toSpanishOrdinal(inYearSemesterNumber)} del a√±o)`;
            document.getElementById('editSubjectForm').reset();
            document.getElementById('editSubjectId').value = '';
            document.getElementById('editSubjectYear').value = year;
            document.getElementById('editSubjectSemester').value = semester;
            document.getElementById('editSubjectScheduleContainer').innerHTML = '';
            populatePreviaSelect('', year, semester);
            document.getElementById('editSubjectModal').classList.remove('hidden');
        }
        function openEditSubjectModal(subjectId) {
            const { semester, subject } = findSubjectAndSemesterById(subjectId);
            if (!subject) return;
            const inYearSemesterNumber = subjectsData.filter(s => s.year === semester.year).findIndex(s => s.semester === semester.semester) + 1;

            document.getElementById('modalTitle').textContent = `Editar Materia: ${subject.name}`;
            document.getElementById('editSubjectId').value = subject.id;
            document.getElementById('editSubjectYear').value = semester.year;
            document.getElementById('editSubjectSemester').value = semester.semester;
            document.getElementById('editSubjectName').value = subject.name;
            document.getElementById('editSubjectCredits').value = subject.credits;
            document.getElementById('editSubjectType').value = subject.type;
            document.getElementById('editDeliveryType').value = subject.deliveryType;
            document.getElementById('editScheduleCode').value = subject.scheduleCode || '';
            document.getElementById('editAssignedCode').value = subject.assignedCode || '';

            const scheduleContainer = document.getElementById('editSubjectScheduleContainer');
            scheduleContainer.innerHTML = '';
            subject.schedule.forEach(slot => addScheduleSlot(slot.day, slot.start, slot.end));

            populatePreviaSelect(subjectId, semester.year, semester.semester);

            document.getElementById('editSubjectModal').classList.remove('hidden');
        }
        function closeEditSubjectModal() { document.getElementById('editSubjectModal').classList.add('hidden'); }
        function addScheduleSlot(day = 'Lunes', start = '', end = '') {
            const container = document.getElementById('editSubjectScheduleContainer');
            const slotDiv = document.createElement('div');
            slotDiv.className = 'flex items-center gap-2 mb-2';
            slotDiv.innerHTML = `
                <select class="day-select shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline">
                    <option ${day === 'Lunes' ? 'selected' : ''}>Lunes</option>
                    <option ${day === 'Martes' ? 'selected' : ''}>Martes</option>
                    <option ${day === 'Mi√©rcoles' ? 'selected' : ''}>Mi√©rcoles</option>
                    <option ${day === 'Jueves' ? 'selected' : ''}>Jueves</option>
                    <option ${day === 'Viernes' ? 'selected' : ''}>Viernes</option>
                    <option ${day === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                    <option ${day === 'Domingo' ? 'selected' : ''}>Domingo</option>
                </select>
                <input type="time" class="start-time-input shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" value="${start}">
                <input type="time" class="end-time-input shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" value="${end}">
                <button type="button" class="remove-slot-btn bg-red-500 text-white py-1 px-2 rounded">&times;</button>
            `;
            container.appendChild(slotDiv);
            slotDiv.querySelector('.remove-slot-btn').onclick = () => slotDiv.remove();
        }
        // MODIFICADO: Se ajust√≥ esta funci√≥n para que el texto de las opciones de materias previas
        // tambi√©n muestre el n√∫mero de semestre dentro del a√±o.
        function populatePreviaSelect(currentSubjectId, currentYear, currentSemester) {
            const previaSelect = document.getElementById('editSubjectPrevias');
            previaSelect.innerHTML = '<option value="">Sin seleccionar</option>';
            const currentSubject = getSubjectById(currentSubjectId);
            const selectedPrevias = currentSubject ? new Set(currentSubject.previas) : new Set();

            const allSemestersInOrder = subjectsData.sort((a,b) => parseInt(a.semester) - parseInt(b.semester));
            const groupedByYear = allSemestersInOrder.reduce((acc, curr) => {
                if (!acc[curr.year]) acc[curr.year] = [];
                acc[curr.year].push(curr);
                return acc;
            }, {});

            Object.values(groupedByYear).forEach(yearSemesters => {
                yearSemesters.forEach((semesterData, index) => {
                    const inYearSemesterNumber = index + 1;
                    semesterData.subjects.forEach(subject => {
                        if (subject.id !== currentSubjectId) {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.textContent = `${subject.name} (${semesterData.year}, Semestre ${semesterData.semester} - ${inYearSemesterNumber} del a√±o)`;
                            if (selectedPrevias.has(subject.id)) {
                                option.selected = true;
                            }
                            previaSelect.appendChild(option);
                        }
                    });
                });
            });
        }
        // MODIFICADO: El t√≠tulo del modal ahora incluye el semestre progresivo y el semestre dentro del a√±o.
        function openDeleteSubjectsModal(year, semester) {
            const listDiv = document.getElementById('deleteSubjectList');
            listDiv.innerHTML = '';
            const semesterData = subjectsData.find(s => s.year === year && s.semester === semester);
            if (semesterData && semesterData.subjects.length > 0) {
                semesterData.subjects.forEach(subject => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'flex justify-between items-center p-2 rounded'; // Removed bg-gray-100
                    subjectDiv.innerHTML = `
                        <span>${subject.name}</span>
                        <button class="delete-one-subject-btn bg-red-500 text-white text-xs py-1 px-2 rounded" data-subject-id="${subject.id}" data-year="${year}" data-semester="${semester}">&times;</button>
                    `;
                    listDiv.appendChild(subjectDiv);
                });
                listDiv.querySelectorAll('.delete-one-subject-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const { subjectId, year, semester } = e.target.dataset;
                        showCustomAlert('Confirmar', `¬øSeguro que quieres eliminar esta materia?`, true, () => {
                            const semData = subjectsData.find(s => s.year === year && s.semester === semester);
                            semData.subjects = semData.subjects.filter(s => s.id !== subjectId);
                            saveSubjectsData();
                            showContent(year);
                            openDeleteSubjectsModal(year, semester);
                        });
                    };
                });
            } else {
                listDiv.innerHTML = '<p>No hay materias para eliminar.</p>';
            }
            document.getElementById('deleteSubjectsModal').classList.remove('hidden');
        }
        function closeDeleteSubjectsModal() { document.getElementById('deleteSubjectsModal').classList.add('hidden'); }
        function showCustomAlert(title, message, isConfirmation = false, confirmCallback = null) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').innerHTML = message;
            const confirmBtn = document.getElementById('alertModalConfirmBtn');
            const modal = document.getElementById('customAlertModal');

            if (isConfirmation) {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (confirmCallback) confirmCallback();
                };
            } else {
                confirmBtn.classList.add('hidden');
            }

            document.getElementById('alertModalCloseBtn').onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }
        function closeGradeStatusModal() { document.getElementById('gradeStatusModal').classList.add('hidden'); }
        function generateSemesterPDF(year, semester) {
            const semesterData = subjectsData.find(s => s.year === year && s.semester === semester);
            if (!semesterData) {
                showCustomAlert('Error', 'No se encontraron datos para este semestre.');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            const pdfContainer = document.createElement('div');
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px';
            pdfContainer.style.width = '1000px';
            pdfContainer.style.padding = '20px';
            pdfContainer.style.backgroundColor = 'white';

            // MODIFICADO: T√≠tulo del PDF ahora incluye el semestre progresivo y el del a√±o.
            const inYearSemesterNumber = subjectsData.filter(s => s.year === year).findIndex(s => s.semester === semester) + 1;
            const inYearSemesterOrdinal = toSpanishOrdinal(inYearSemesterNumber);
            const title = document.createElement('h2');
            title.style.fontSize = '24px';
            title.style.textAlign = 'center';
            title.style.marginBottom = '20px';
            title.textContent = `Horario: ${year} - Semestre ${semester} (${inYearSemesterOrdinal} del a√±o)`;
            pdfContainer.appendChild(title);

            const table = document.createElement('table');
            table.id = 'pdfScheduleTable';
            table.className = 'schedule-table';
            table.style.width = '100%';
            table.style.fontSize = '12px';
            table.innerHTML = '<thead><tr><th>Hora</th><th>Lunes</th><th>Martes</th><th>Mi√©rcoles</th><th>Jueves</th><th>Viernes</th><th>S√°bado</th><th>Domingo</th></tr></thead><tbody></tbody>';
            pdfContainer.appendChild(table);
            document.body.appendChild(pdfContainer);

            populateScheduleTable(semesterData, 'pdfScheduleTable');

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                html2canvas(pdfContainer, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const imgWidth = pdfWidth - 20;
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    pdf.save(`horario-${year}-sem${semester}.pdf`);

                    document.body.removeChild(pdfContainer);
                    loadingOverlay.classList.add('hidden');
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    document.body.removeChild(pdfContainer);
                    loadingOverlay.classList.add('hidden');
                    showCustomAlert('Error', 'Hubo un problema al generar el PDF.');
                });
            }, 100);
        }
        function getSemesterTypeHours(subjects) {
            const hours = { Obligatoria: 0, Opcional: 0, Electiva: 0 };
            subjects.forEach(sub => {
                let subjectHours = 0;
                sub.schedule.forEach(slot => {
                    const start = new Date(`1970-01-01T${slot.start}`);
                    const end = new Date(`1970-01-01T${slot.end}`);
                    subjectHours += (end - start) / (1000 * 60 * 60);
                });
                if (hours.hasOwnProperty(sub.type)) {
                    hours[sub.type] += subjectHours;
                }
            });
            return hours;
        }
        function renderDonutChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (window.semesterCharts[canvasId]) {
                window.semesterCharts[canvasId].destroy();
            }
            window.semesterCharts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            colorSettings.typeObligatoria,
                            colorSettings.typeOpcional,
                            colorSettings.typeElectiva
                        ],
                        hoverOffset: 0 // MODIFIED: Remove hover animation
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: isDarkMode ? '#f7fafc' : '#2d3748'
                            }
                        },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${context.raw.toFixed(1)} horas` } }
                    },
                    borderWidth: 0
                }
            });
        }
        function getSemesterDailyHours(subjects) {
            const days = { Lunes: 0, Martes: 0, Mi√©rcoles: 0, Jueves: 0, Viernes: 0, S√°bado: 0, Domingo: 0 };
            subjects.forEach(sub => {
                sub.schedule.forEach(slot => {
                    const start = new Date(`1970-01-01T${slot.start}`);
                    const end = new Date(`1970-01-01T${slot.end}`);
                    const duration = (end - start) / (1000 * 60 * 60);
                    if (days.hasOwnProperty(slot.day)) {
                        days[slot.day] += duration;
                    }
                });
            });
            return days;
        }
        function renderDailyLoadBoxes(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (const [day, hours] of Object.entries(data)) {
                if (hours > 0) {
                    const box = document.createElement('div');
                    // Se reemplazan las clases de Tailwind hardcodeadas por la nueva clase din√°mica
                    box.className = 'p-3 rounded-lg shadow text-center daily-load-box';
                    box.innerHTML = `<div class="font-bold daily-load-day">${day}</div><div class="text-lg daily-load-hours">${hours.toFixed(1)}h</div>`;
                    container.appendChild(box);
                }
            }
        }
        function calculateSemesterTotalWeeklyHours(subjects) {
            return Object.values(getSemesterDailyHours(subjects)).reduce((acc, hours) => acc + hours, 0);
        }
        function openSettingsModal() {
            document.getElementById('editCareerTitle').value = careerSettings.careerTitle;
            document.getElementById('editTotalCareerCredits').value = careerSettings.totalCareerCredits;
            document.getElementById('editIntermediateTitleCredits').value = careerSettings.intermediateTitleCredits;
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() {
            careerSettings.careerTitle = document.getElementById('editCareerTitle').value;
            careerSettings.totalCareerCredits = parseInt(document.getElementById('editTotalCareerCredits').value);
            careerSettings.intermediateTitleCredits = parseInt(document.getElementById('editIntermediateTitleCredits').value);
            saveCareerSettings();
            closeSettingsModal();
        }
        function saveSubjectChanges() {
            const subjectId = document.getElementById('editSubjectId').value;
            const year = document.getElementById('editSubjectYear').value;
            const semester = document.getElementById('editSubjectSemester').value;
            const newName = document.getElementById('editSubjectName').value.trim();
            const newCredits = parseInt(document.getElementById('editSubjectCredits').value);
            const newType = document.getElementById('editSubjectType').value;
            const newDeliveryType = document.getElementById('editDeliveryType').value;
            const newScheduleCodeInput = document.getElementById('editScheduleCode').value;
            const newScheduleCode = newScheduleCodeInput === '' ? null : parseInt(newScheduleCodeInput);
            const newAssignedCode = document.getElementById('editAssignedCode').value.trim();

            const selectedPrevias = Array.from(document.getElementById('editSubjectPrevias').selectedOptions)
                .map(option => option.value).filter(value => value !== '');

            if (!newName || isNaN(newCredits) || newCredits <= 0) {
                showCustomAlert('Error', 'Nombre y cr√©ditos son requeridos.');
                return;
            }

            const updatedSchedule = [];
            let hasInvalidTime = false;
            document.querySelectorAll('#editSubjectScheduleContainer > div').forEach(slotDiv => {
                const day = slotDiv.querySelector('.day-select').value;
                const start = slotDiv.querySelector('.start-time-input').value;
                const end = slotDiv.querySelector('.end-time-input').value;
                if (!start || !end || new Date(`1970/01/01 ${start}`) >= new Date(`1970/01/01 ${end}`)) {
                    hasInvalidTime = true;
                }
                updatedSchedule.push({ day, start, end });
            });

            if (hasInvalidTime) {
                showCustomAlert('Error', 'Horarios inv√°lidos detectados.');
                return;
            }

            const targetSemester = subjectsData.find(s => s.year === year && s.semester === semester);

            if (subjectId) {
                const { subject } = findSubjectAndSemesterById(subjectId);
                Object.assign(subject, {
                    name: newName, credits: newCredits, type: newType, deliveryType: newDeliveryType,
                    scheduleCode: newScheduleCode, assignedCode: newAssignedCode,
                    schedule: updatedSchedule, previas: selectedPrevias
                });
            } else {
                const newSubject = {
                    id: generateUniqueId(), name: newName, credits: newCredits, type: newType,
                    deliveryType: newDeliveryType, scheduleCode: newScheduleCode, assignedCode: newAssignedCode,
                    schedule: updatedSchedule, previas: selectedPrevias,
                    resources: { summary: '', links: [] },
                    partial1Notes: '', partial2Notes: '', examNotes: ''
                };
                targetSemester.subjects.push(newSubject);
            }

            if (targetSemester) updateSemesterOverlaps(targetSemester);
            saveSubjectsData();
            recalculateCompletedCredits();
            showContent(currentActiveView);
            closeEditSubjectModal();
        }
        function saveGradeStatusChanges() {
            const subjectId = document.getElementById('gradeStatusSubjectId').value;
            const { subject } = findSubjectAndSemesterById(subjectId);
            if (!subject) return;

            // Initialize grade objects if they don't exist to prevent errors
            subject.partial1Grade = subject.partial1Grade || { type: 'Conceptual', value: 'No Definido' };
            subject.partial2Grade = subject.partial2Grade || { type: 'Conceptual', value: 'No Definido' };
            subject.finalAverageGrade = subject.finalAverageGrade || { type: 'Conceptual', value: 'No Definido' };
            subject.examGrade = subject.examGrade || { type: 'Conceptual', value: 'No Definido' };

            // Update grade types and values from the form inputs
            subject.partial1Grade.type = document.getElementById('partial1GradeType').value;
            subject.partial1Grade.value = document.getElementById('partial1GradeValue').value;
            subject.partial1Icon = document.getElementById('partial1Indicator').dataset.selectedType || '';

            subject.partial2Grade.type = document.getElementById('partial2GradeType').value;
            subject.partial2Grade.value = document.getElementById('partial2GradeValue').value;
            subject.partial2Icon = document.getElementById('partial2Indicator').dataset.selectedType || '';

            subject.finalAverageGrade.type = document.getElementById('finalAverageGradeType').value;
            subject.finalAverageGrade.value = document.getElementById('finalAverageGradeValue').value;

            subject.examStatus = document.getElementById('inputExamStatus').value;
            if (subject.examStatus === 'A Examen') {
                subject.examGrade.type = document.getElementById('examGradeType').value;
                subject.examGrade.value = document.getElementById('examGradeValue').value;
                subject.examDate = document.getElementById('inputExamDate').value;
                subject.examTime = document.getElementById('inputExamTime').value;
            } else {
                subject.examGrade = { type: 'Conceptual', value: 'No Definido' };
                subject.examDate = '';
                subject.examTime = '';
            }

            // Update other subject details
            subject.partial1Date = document.getElementById('inputPartial1Date').value;
            subject.partial1Time = document.getElementById('inputPartial1Time').value;
            subject.partial2Date = document.getElementById('inputPartial2Date').value;
            subject.partial2Time = document.getElementById('inputPartial2Time').value;
            subject.professor = document.getElementById('inputProfessor').value.trim();
            subject.zoomUrl = document.getElementById('inputZoomUrl').value.trim();
            subject.classroom = document.getElementById('inputClassroom').value.trim();
            subject.controlNumber = document.getElementById('inputControlNumber').value.trim();
            subject.partial1Notes = document.getElementById('partial1Notes').value;
            subject.partial2Notes = document.getElementById('partial2Notes').value;
            subject.examNotes = document.getElementById('examNotes').value;

            // Update completed status
            if (subject.examStatus === 'Salvada') {
                completedSubjects.add(subject.id);
            } else {
                completedSubjects.delete(subject.id);
            }

            saveSubjectsData();
            saveCompletedSubjects();
            recalculateCompletedCredits();
            showContent(currentActiveView);
            renderAcademicCalendar();
            renderNotificationBanner();
            closeGradeStatusModal();
        }
        function openSubjectInfoModal(subjectId) {
            const result = findSubjectAndSemesterById(subjectId);
            if (!result) {
                console.error("Subject not found for ID:", subjectId);
                return;
            }
            const { semester, subject } = result;

            const subjectInfoContent = document.getElementById('subjectInfoContent');
            const inYearSemesterNumber = subjectsData.filter(s => s.year === semester.year).findIndex(s => s.semester === semester.semester) + 1;


            const previasHtml = subject.previas.length > 0 ?
                `<ul class="list-disc list-inside">${subject.previas.map(id => `<li>${getSubjectById(id)?.name || 'N/A'}</li>`).join('')}</ul>` : '<li>Ninguna</li>';
            const scheduleHtml = subject.schedule.length > 0 ?
                `<ul class="list-disc list-inside">${subject.schedule.map(s => `<li>${s.day}: ${s.start} - ${s.end}</li>`).join('')}</ul>` : '<li>No hay horario</li>';

            const displayGrade = (g) => g && g.value ? `${g.value} (${g.type})` : 'N/A';
            const displayPartialIcon = (i) => ({check:'‚úîÔ∏è', tilde:'„ÄΩÔ∏è', cross:'‚ùåÔ∏è'}[i] || '');

            const p1Date = subject.partial1Date ? `(${new Date(subject.partial1Date + 'T12:00:00').toLocaleDateString('es-ES')})` : '';
            const p2Date = subject.partial2Date ? `(${new Date(subject.partial2Date + 'T12:00:00').toLocaleDateString('es-ES')})` : '';
            const examDate = subject.examDate ? `(${new Date(subject.examDate + 'T12:00:00').toLocaleDateString('es-ES')})` : '';

            // NUEVO: Generar HTML para la informaci√≥n de profesor, etc.
            const additionalInfoHtml = `
                <h3 class="text-lg font-semibold mt-4 mb-2">Informaci√≥n Adicional:</h3>
                <p><strong>Profesor:</strong> ${subject.professor || 'N/A'}</p>
                <p><strong>URL Zoom:</strong> ${subject.zoomUrl ? `<a href="${subject.zoomUrl}" target="_blank" class="text-blue-600 hover:underline">Enlace</a>` : 'N/A'}</p>
                <p><strong>Aula:</strong> ${subject.classroom || 'N/A'}</p>
                <p><strong>N√∫mero de Control:</strong> ${subject.controlNumber || 'N/A'}</p>
            `;

            const notesHtml = `
                <h4 class="font-semibold mt-3">Notas de Evaluaciones:</h4>
                <p><strong>Primer Parcial:</strong><br>${subject.partial1Notes || 'Sin notas.'}</p>
                <p><strong>Segundo Parcial:</strong><br>${subject.partial2Notes || 'Sin notas.'}</p>
                <p><strong>Examen Final:</strong><br>${subject.examNotes || 'Sin notas.'}</p>
            `;

            const summaryHtml = `
                <h3 class="text-lg font-semibold mt-4 mb-2">Resumen:</h3>
                <!-- MODIFIED: Added a dynamic class for dark mode styling -->
                <div class="p-2 bg-gray-100 rounded-md whitespace-pre-wrap">${subject.resources?.summary || 'No hay resumen disponible.'}</div>
            `;

            subjectInfoContent.innerHTML = `
                <p><strong>Nombre:</strong> ${subject.name}</p>
                <p><strong>Cr√©ditos:</strong> ${subject.credits}</p>
                <p><strong>Tipo:</strong> ${subject.type}</p>
                <p><strong>Modalidad:</strong> ${subject.deliveryType}</p>
                <p><strong>Semestre:</strong> ${semester.semester} (${toSpanishOrdinal(inYearSemesterNumber)} del a√±o)</p>
                <h3 class="text-lg font-semibold mt-4 mb-2">Notas y Fechas:</h3>
                <p><strong>Primer Parcial:</strong> ${displayGrade(subject.partial1Grade)} ${displayPartialIcon(subject.partial1Icon)} ${p1Date}</p>
                <p><strong>Segundo Parcial:</strong> ${displayGrade(subject.partial2Grade)} ${displayPartialIcon(subject.partial2Icon)} ${p2Date}</p>
                <p><strong>Promedio Final:</strong> ${displayGrade(subject.finalAverageGrade)}</p>
                <p><strong>Estado Examen:</strong> ${subject.examStatus} ${examDate}</p>
                ${additionalInfoHtml}
                <h3 class="text-lg font-semibold mt-4 mb-2">Materias Previas:</h3>${previasHtml}
                <h3 class="text-lg font-semibold mt-4 mb-2">Horario:</h3>${scheduleHtml}
                ${notesHtml}
                ${summaryHtml}
            `;

            document.getElementById('subjectInfoModal').classList.remove('hidden');
        }
        function openGradeStatusModal(subjectId) {
            const { subject } = findSubjectAndSemesterById(subjectId);
            if (!subject) return;

            subject.partial1Grade = subject.partial1Grade || { type: 'Conceptual', value: 'No Definido' };
            subject.partial2Grade = subject.partial2Grade || { type: 'Conceptual', value: 'No Definido' };
            subject.finalAverageGrade = subject.finalAverageGrade || { type: 'Conceptual', value: 'No Definido' };
            subject.examGrade = subject.examGrade || { type: 'Conceptual', value: 'No Definido' };


            document.getElementById('gradeStatusSubjectId').value = subject.id;
            document.getElementById('gradeStatusModalTitle').textContent = `Notas y Estado de: ${subject.name}`;

            const p1TypeSelect = document.getElementById('partial1GradeType');
            p1TypeSelect.innerHTML = '<option value="Conceptual">Conceptual</option><option value="Numerica">Num√©rica</option><option value="Porcentaje">Porcentaje</option>';
            p1TypeSelect.value = subject.partial1Grade.type;
            p1TypeSelect.dataset.targetId = 'partial1GradeValue';
            p1TypeSelect.dataset.gradeContext = 'partial';
            updateGradeInput(p1TypeSelect, 'partial1GradeValue', 'partial', subject.partial1Grade.value);
            updatePartialGradeIndicatorDisplay('partial1Indicator', subject.partial1Icon || '');
            document.getElementById('inputPartial1Date').value = subject.partial1Date || '';
            document.getElementById('inputPartial1Time').value = subject.partial1Time || '';
            document.getElementById('partial1Notes').value = subject.partial1Notes || '';

            const p2TypeSelect = document.getElementById('partial2GradeType');
            p2TypeSelect.innerHTML = '<option value="Conceptual">Conceptual</option><option value="Numerica">Num√©rica</option><option value="Porcentaje">Porcentaje</option>';
            p2TypeSelect.value = subject.partial2Grade.type;
            p2TypeSelect.dataset.targetId = 'partial2GradeValue';
            p2TypeSelect.dataset.gradeContext = 'partial';
            updateGradeInput(p2TypeSelect, 'partial2GradeValue', 'partial', subject.partial2Grade.value);
            updatePartialGradeIndicatorDisplay('partial2Indicator', subject.partial2Icon || '');
            document.getElementById('inputPartial2Date').value = subject.partial2Date || '';
            document.getElementById('inputPartial2Time').value = subject.partial2Time || '';
            document.getElementById('partial2Notes').value = subject.partial2Notes || '';

            const finalAvgTypeSelect = document.getElementById('finalAverageGradeType');
            finalAvgTypeSelect.innerHTML = '<option value="Conceptual">Conceptual</option><option value="Numerica">Num√©rica</option><option value="Porcentaje">Porcentaje</option>';
            finalAvgTypeSelect.value = subject.finalAverageGrade.type;
            finalAvgTypeSelect.dataset.targetId = 'finalAverageGradeValue';
            finalAvgTypeSelect.dataset.gradeContext = 'final';
            updateGradeInput(finalAvgTypeSelect, 'finalAverageGradeValue', 'final', subject.finalAverageGrade.value);

            const examStatusSelect = document.getElementById('inputExamStatus');
            examStatusSelect.value = subject.examStatus || 'No Definido';
            const examDateTimeContainer = document.getElementById('examDateTimeContainer');
            if (examStatusSelect.value === 'A Examen') {
                examDateTimeContainer.classList.remove('hidden');
                const examGradeTypeSelect = document.getElementById('examGradeType');
                examGradeTypeSelect.innerHTML = '<option value="Conceptual">Conceptual</option><option value="Numerica">Num√©rica</option><option value="Porcentaje">Porcentaje</option>';
                examGradeTypeSelect.value = subject.examGrade.type;
                examGradeTypeSelect.dataset.targetId = 'examGradeValue';
                examGradeTypeSelect.dataset.gradeContext = 'final';
                updateGradeInput(examGradeTypeSelect, 'examGradeValue', 'final', subject.examGrade.value);
                document.getElementById('inputExamDate').value = subject.examDate || '';
                document.getElementById('inputExamTime').value = subject.examTime || '';
                document.getElementById('examNotes').value = subject.examNotes || '';
            } else {
                examDateTimeContainer.classList.add('hidden');
            }

            document.getElementById('inputProfessor').value = subject.professor || '';
            document.getElementById('inputZoomUrl').value = subject.zoomUrl || '';
            document.getElementById('inputClassroom').value = subject.classroom || '';
            document.getElementById('inputControlNumber').value = subject.controlNumber || '';

            document.getElementById('gradeStatusModal').classList.remove('hidden');
        }
        function renderNotificationBanner() {
            const upcomingEvents = getAcademicEvents(true);
            const banner = document.getElementById('notificationBanner');
            const message = document.getElementById('notificationMessage');
            const count = document.getElementById('notificationCount');

            if (upcomingEvents.length > 0) {
                message.textContent = `Tienes ${upcomingEvents.length} notificaciones pr√≥ximas`;
                count.textContent = upcomingEvents.length;
                banner.classList.remove('hidden');
            } else {
                message.textContent = 'No hay notificaciones pr√≥ximas.';
                count.textContent = 0;
                banner.classList.add('hidden');
            }
        }
        function openUpcomingEventsModal() {
            const upcomingEvents = getAcademicEvents(true);
            // CORREGIDO: Se usa la clase 'notification-event-item' en lugar de 'bg-gray-100'
            const eventListHtml = upcomingEvents.map(event => {
                const eventDate = new Date(event.eventDate + 'T12:00:00');
                return `<div class="flex justify-between items-center p-2 rounded notification-event-item">
                            <span>${event.name} (${event.eventType}) - ${eventDate.toLocaleDateString('es-ES')}</span>
                            <button class="delete-event-btn text-red-500 font-bold" data-subject-id="${event.subjectId}" data-event-type="${event.eventType}">&times;</button>
                        </div>`;
            }).join('');

            const modalContent = `<div class="space-y-2">${eventListHtml || '<p>No hay eventos pr√≥ximos.</p>'}</div>`;
            showCustomAlert('Pr√≥ximos Eventos', modalContent);

            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const { subjectId, eventType } = e.currentTarget.dataset;
                    deleteAcademicEvent(subjectId, eventType);
                };
            });
        }
        function deleteAcademicEvent(subjectId, eventType) {
            const { subject } = findSubjectAndSemesterById(subjectId);
            if (!subject) return;

            switch (eventType) {
                case 'Primer Parcial':
                    subject.partial1Date = '';
                    subject.partial1Time = '';
                    break;
                case 'Segundo Parcial':
                    subject.partial2Date = '';
                    subject.partial2Time = '';
                    break;
                case 'Examen Final':
                    subject.examDate = '';
                    subject.examTime = '';
                    break;
            }

            saveSubjectsData();
            renderNotificationBanner();
            renderAcademicCalendar();
            document.getElementById('customAlertModal').classList.add('hidden');
            openUpcomingEventsModal();
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('darkModeToggle').textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';
            for (const chartId in window.semesterCharts) {
                if (window.semesterCharts.hasOwnProperty(chartId)) {
                    const semesterId = chartId.replace('typeChart-', '');
                    const [year, semester] = semesterId.split('-');
                    const semesterData = subjectsData.find(s => s.year === year && s.semester === semester);
                    renderDonutChart(chartId, getSemesterTypeHours(semesterData.subjects));
                }
            }
            saveDarkMode();
        }

        document.addEventListener('DOMContentLoaded', () => {
            subjectsData.forEach(sem => sem.subjects.forEach(sub => {
                if(typeof sub.summary === 'string') {
                    sub.resources = { summary: sub.summary, files: [], links: [] };
                    delete sub.summary;
                }
            }));

            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('darkModeToggle').textContent = isDarkMode ? 'üåô' : '‚òÄÔ∏è';

            applyCustomColors();
            populateColorPaletteInputs();
            updateHeaderDisplay();
            recalculateCompletedCredits();
            calculateTotalAvailableCredits();
            renderYearSelectionButtons();
            populateCalendarYearSelect();
            renderAcademicCalendar();
            renderNotificationBanner();

            document.getElementById('openSettingsModalBtn').onclick = openSettingsModal;
            document.getElementById('saveSettingsBtn').onclick = saveSettings;
            document.getElementById('cancelSettingsBtn').onclick = closeSettingsModal;
            document.getElementById('addYearBtn').onclick = () => document.getElementById('addYearSemestersModal').classList.remove('hidden');
            document.getElementById('confirmAddSemestersBtn').onclick = addYear;
            document.getElementById('cancelAddSemestersBtn').onclick = () => document.getElementById('addYearSemestersModal').classList.add('hidden');
            document.getElementById('removeYearBtn').onclick = removeCurrentYear;
            document.getElementById('saveSubjectBtn').onclick = saveSubjectChanges;
            document.getElementById('cancelSubjectBtn').onclick = closeEditSubjectModal;
            document.getElementById('addScheduleSlotBtn').onclick = () => addScheduleSlot();
            document.getElementById('cancelDeleteSubjectsBtn').onclick = closeDeleteSubjectsModal;
            document.getElementById('calendarMainButton').onclick = () => {
                currentActiveView = 'Calendario Lectivo';
                document.getElementById('calendarWrapper').classList.remove('hidden');
                document.getElementById('academicPathWrapper').classList.add('hidden');
                document.getElementById('semesterContentArea').classList.add('hidden');
                document.getElementById('calendarMainButton').classList.add('active');
                document.getElementById('academicPathButton').classList.remove('active');
                document.querySelectorAll('.year-button').forEach(btn => btn.classList.remove('active'));
            };
            document.getElementById('academicPathButton').onclick = showAcademicPath;
            document.getElementById('prevMonthBtn').onclick = prevMonth;
            document.getElementById('nextMonthBtn').onclick = nextMonth;
            document.getElementById('closeAcademicDetailsModalBtn').onclick = () => document.getElementById('academicDetailsModal').classList.add('hidden');
            document.getElementById('saveGradeStatusBtn').onclick = saveGradeStatusChanges;
            document.getElementById('cancelGradeStatusBtn').onclick = closeGradeStatusModal;
            document.getElementById('closeSubjectInfoModalBtn').onclick = () => document.getElementById('subjectInfoModal').classList.add('hidden');

            document.getElementById('notificationBanner').onclick = openUpcomingEventsModal;

            document.getElementById('darkModeToggle').onclick = toggleDarkMode;

            document.getElementById('openPaletteBtn').onclick = () => document.getElementById('colorPalettePanel').classList.add('visible');
            document.getElementById('closePaletteBtn').onclick = () => document.getElementById('colorPalettePanel').classList.remove('visible');
            document.getElementById('resetColorsBtn').onclick = () => {
                colorSettings = { ...defaultColorSettings };
                saveColorSettings();
                populateColorPaletteInputs();
                applyCustomColors();
                renderYearSelectionButtons();
                showContent(currentActiveView);
                renderAcademicPath();
            };
            document.querySelectorAll('#colorPalettePanel input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const key = e.target.dataset.key;
                    const value = e.target.value;
                    colorSettings[key] = value;
                    const colorInput = document.querySelector(`#colorPalettePanel input[type="color"][data-key="${key}"]`);
                    const hexInput = document.querySelector(`#colorPalettePanel input[type="text"][data-key="${key}"]`);
                    colorInput.value = value;
                    hexInput.value = value;
                    applyCustomColors();
                    saveColorSettings();
                    renderYearSelectionButtons();
                    showContent(currentActiveView);
                    renderAcademicPath();
                });
            });

            document.getElementById('saveResourcesBtn').onclick = saveResources;
            document.getElementById('cancelResourcesBtn').onclick = closeResourceModal;
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            document.getElementById('addLinkBtn').onclick = addLink;
            document.getElementById('linkList').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    deleteResourceItem(document.getElementById('resourceSubjectId').value, e.target.dataset.type, e.target.dataset.index);
                }
            });

            document.getElementById('openGoalsModalBtn').onclick = openGoalsModal;
            document.getElementById('closeGoalsModalBtn').onclick = closeGoalsModal;
            document.getElementById('addGoalBtn').onclick = addGoal;
            document.getElementById('goalList').addEventListener('click', (e) => {
                if (e.target.type === 'checkbox') {
                    toggleGoalStatus(e.target.dataset.index);
                } else if (e.target.tagName === 'BUTTON') {
                    deleteGoal(e.target.dataset.index);
                }
            });
            // Attach event listeners for grade type selects
            document.querySelectorAll('.grade-type-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const selectElement = e.target;
                    const targetId = selectElement.id.replace('Type', 'Value');
                    const gradeContext = targetId.includes('partial') ? 'partial' : 'final';
                    
                    // --- CORRECCI√ìN DEL BUG: Obtener el valor actual del DOM antes de reemplazarlo ---
                    const currentValueInput = document.getElementById(targetId);
                    const currentValue = currentValueInput ? currentValueInput.value : '';
                    // ----------------------------------------------------------------------------------

                    // Now pass the current value to the function to correctly re-render
                    updateGradeInput(selectElement, targetId, gradeContext, currentValue);
                });
            });

            document.getElementById('inputExamStatus').onchange = (e) => {
                document.getElementById('examDateTimeContainer').classList.toggle('hidden', e.target.value !== 'A Examen');
            };
            document.querySelectorAll('.partial-indicator-btn').forEach(btn => {
                btn.onclick = () => updatePartialGradeIndicatorDisplay(btn.dataset.targetIndicator, btn.dataset.indicatorType);
            });
        });
    </script>
</body>
</html>

